<!DOCTYPE html>
<html lang="pt-BR" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Funil - HocketZap</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/jsplumb@2.15.6/dist/js/jsplumb.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
           :root {
  --primary-color: #4CAF50;
  --secondary-color: #2196F3;
  --background-color: #f0f4f8;
  --text-color: #333;
  --menu-width: 280px;
}

body {
  font-family: 'Poppins', sans-serif;
  background-color: var(--background-color);
  color: var(--text-color);
}

        .node-message { background-color: #E3F2FD; border-left: 4px solid #2196F3; }
        .node-input { background-color: #E8F5E9; border-left: 4px solid #4CAF50; }
        .node-condition { background-color: #FFF3E0; border-left: 4px solid #FF9800; }
        .node-wait { background-color: #F3E5F5; border-left: 4px solid #9C27B0; }
        .node-image { background-color: #FCE4EC; border-left: 4px solid #E91E63; }
        .node-audio { background-color: #E8EAF6; border-left: 4px solid #3F51B5; }
        .node-video { background-color: #FFEBEE; border-left: 4px solid #F44336; }
        .node-file { background-color: #ECEFF1; border-left: 4px solid #607D8B; }

        .canvas {
            width: 5000px;
            height: 5000px;
            position: relative;
            background-color: #f0f4f8;
            background-image: 
                radial-gradient(#e6e6e6 1px, transparent 1px),
                radial-gradient(#e6e6e6 1px, transparent 1px);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            transform-origin: 0 0;
        }

        .canvas-container {
            width: 100%;
            height: calc(100vh - 64px);
            overflow: auto;
            cursor: grab;
        }

        .canvas-container:active {
            cursor: grabbing;
        }

        .node {
            position: absolute;
            width: 250px;
            border-radius: 12px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), 0 1px 3px rgba(0, 0, 0, 0.08);
   
            background-color: white;
          
            user-select: none;
         
        }

        .node:hover {
    transform: translateY(-2px);
    box-shadow: 0 7px 14px rgba(0, 0, 0, 0.1), 0 3px 6px rgba(0, 0, 0, 0.08);
}

        .node-header {


            padding: 12px;
    border-top-left-radius: 12px;
    border-top-right-radius: 12px;
    font-weight: bold;

           
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
           
        }

        .node-header svg {
    width: 20px;
    height: 20px;
    margin-right: 8px;
}

/* Adicione ao seu CSS existente */

.button-container {
    position: relative;
    margin: 8px 0;
    padding: 6px 12px;
    background-color: #f3f4f6;
    border-radius: 6px;
    border: 1px solid #e5e7eb;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.button-text {
    font-size: 0.875rem;
    color: #374151;
}

.button-endpoint {
    width: 8px;
    height: 8px;
    background-color: #48BB78;
    border-radius: 50%;
    margin-left: 8px;
}

.button-container:hover {
    background-color: #e5e7eb;
    cursor: pointer;
}

.jtk-connector {
    z-index: 4;
}

.jtk-endpoint {
    z-index: 5;
}

.jtk-overlay {
    z-index: 6;
}

.node[data-type="buttons"] {
    min-width: 250px;
}

        .node-content {
            padding: 12px;
    background-color: #ffffff;
    border-bottom-left-radius: 12px;
    border-bottom-right-radius: 12px;
        }

        .endpoint-label {
    pointer-events: none;
    user-select: none;
    font-size: 12px;
    font-weight: bold;
    color: white;
    text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
}

.endpoint-yes {
    background-color: #48BB78 !important;
}

.endpoint-no {
    background-color: #F56565 !important;
}

        .endpoint:hover {
            transform: scale(1.2);
        }

       

        .node-footer {
            position: relative;
            height: 20px;
        }

   

.side-menu {
  position: fixed;
  left: 0;
  top: 0;
  bottom: 0;
  width: var(--menu-width);
  background-color: white;
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  overflow-y: auto;
  z-index: 1000;
  transition: all 0.3s ease;
}

.menu-header {
  padding: 1.5rem;
  background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
  color: white;
}

.app-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0;
  text-align: center;
  letter-spacing: 1px;
}

.menu-content {
  padding: 1rem;
}

.menu-section {
  margin-bottom: 2rem;
}

.menu-section h3 {
  font-size: 1rem;
  font-weight: 600;
  color: var(--primary-color);
  margin-bottom: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.menu-items {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 0.75rem;
}


.node.dragging {
    opacity: 0.8;
    cursor: grabbing !important;
}


.menu-item.dragging {
    opacity: 0.5;
    cursor: grabbing;
}

.menu-item {

  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 0.75rem;
  border-radius: 0.5rem;
  background-color: #f8f9fa;
  border: 1px solid #e9ecef;
   cursor: grab;
  transition: all 0.2s ease;
}

.menu-item:hover {
  background-color: #e9ecef;
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.menu-item svg {
  width: 1.75rem;
  height: 1.75rem;
  margin-bottom: 0.5rem;
  color: var(--secondary-color);
}

.menu-item span {
  font-size: 0.8rem;
  text-align: center;
  font-weight: 500;
}

.canvas-container {
  margin-left: var(--menu-width);
  transition: margin-left 0.3s ease;
}

/* Animação para os itens do menu */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.menu-item {
  animation: fadeIn 0.3s ease forwards;
}

.menu-item:nth-child(odd) {
  animation-delay: 0.1s;
}

.menu-item:nth-child(even) {
  animation-delay: 0.2s;
}



    .node-start {
    background-color: #f3f4f6;
    border: 2px solid #e5e7eb;
    border-radius: 20px;
    padding: 10px 15px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    width: auto;
    min-width: 100px;
    max-width: 200px;
}

.node-start .node-header {
    background-color: transparent;
    color: #374151;
    font-weight: 600;
    font-size: 14px;
    padding: 0;
    border-bottom: none;
    display: flex;
    align-items: center;
}

.node-start .node-content {
    display: none;
}

.node-start .node-header svg {
    width: 20px;
    height: 20px;
    margin-right: 8px;
}

   

    .node-footer {
    padding: 5px 10px;
    font-size: 10px;
    color: #9CA3AF;
    text-align: right;
    border-top: 1px solid #E5E7EB;
}



    
        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .jtk-connector {
            z-index: 4;
        }

        .jtk-endpoint {
            z-index: 5;
        }

        .jtk-overlay {
            z-index: 6;
        }

        .media-preview {
    max-width: 100%;
    max-height: 150px;
    margin-top: 8px;
    border-radius: 4px;
    overflow: hidden;
    background-color: #f3f4f6;
}

.media-preview img,
.media-preview video {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.media-preview audio {
    width: 100%;
    margin-top: 8px;
}

        .zoom-controls {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
        }

        @media (max-width: 640px) {
            .fixed-menu {
                bottom: 0;
                left: 0;
                right: 0;
                flex-direction: row;
                justify-content: space-around;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <nav class="bg-white shadow-md p-4">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                </svg>
                <span id="funnelName"><%= funnel.name %></span>
            </h1>
                <input type="text" id="nodeSearch" placeholder="Pesquisar nós..." class="mr-4 p-2 border rounded-md shadow-sm">
            <button onclick="saveFunnel()" class="btn bg-green-500 text-white px-4 py-2 rounded-full hover:bg-green-600 transition duration-300 flex items-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path>
                </svg>
                Salvar
            </button>
        </div>
    </nav>

    <div class="zoom-controls">
        <button onclick="zoomIn()" class="btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-300">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
            </svg>
        </button>
        <button onclick="zoomOut()" class="btn bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 transition duration-300 mt-2">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
            </svg>
        </button>
    </div>

    <div id="sideMenu" class="side-menu">
        <div class="menu-header">
          <h1 class="app-title">HocketZap</h1>
        </div>
        <div class="menu-content">
          <div class="menu-section">
            <h3>Mensagens</h3>
            <div class="menu-items" id="messagesItems"></div>
          </div>
          <div class="menu-section">
            <h3>Lógica</h3>
            <div class="menu-items" id="logicItems"></div>
          </div>
          <div class="menu-section">
            <h3>Ações</h3>
            <div class="menu-items" id="actionsItems"></div>
          </div>
        </div>
      </div>

    <main class="flex-1 overflow-hidden">
        <div id="canvas-container" class="canvas-container">
            <div id="canvas" class="canvas">
                <!-- Os nós do fluxo serão renderizados aqui -->
            </div>
        </div>
    </main>

 
      
  
    

    <!-- Modal para edição de nós -->
    <div id="editModal" class="fixed z-10 inset-0 overflow-y-auto hidden">
        <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <h3 class="text-lg leading-6 font-medium text-gray-900" id="modalTitle"></h3>
                    <div class="mt-2" id="modalContent"></div>
                </div>
                <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-blue-600 text-base font-medium text-white hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 sm:ml-3 sm:w-auto sm:text-sm" onclick="saveNodeEdit()">
                        Salvar
                    </button>
                    <button type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm" onclick="closeModal()">
                        Cancelar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
    let jsPlumbInstance;
    let nodes = [];
    let connections = [];
    let editingNodeId = null;
    let zoomLevel = 1;
    let isDragging = false;
    let startX, startY, scrollLeft, scrollTop;
    let container;


    const nodeIcons = {
    message: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>',
    input: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>',
    condition: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>',
    collectNumber: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>',
    savePurchaseEvent: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"></path></svg>',
    sendToOtherNumber: '<svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>',
    // Adicione ícones para outros tipos de nós
};

    document.addEventListener('DOMContentLoaded', function() {
        container = document.querySelector('.canvas-container');

        jsPlumbInstance = jsPlumb.getInstance({
    Connector: ["Flowchart", { stub: 30, gap: 10, cornerRadius: 5, alwaysRespectStubs: true }],
    Anchors: ["Right", "Left"],
    Endpoint: ["Dot", { radius: 4 }],
    PaintStyle: { stroke: "#6366F1", strokeWidth: 3 },
    HoverPaintStyle: { stroke: "#4338CA", strokeWidth: 4 },
    ConnectionOverlays: [
        ["Arrow", { 
            location: 1,
            width: 12,
            length: 12,
            foldback: 0.8
        }]
    ]
});
        jsPlumbInstance.setContainer("canvas");
        addStartNode();

        // Carregar o funil existente
       // Carregar o funil existente
        // Carregar o funil existente
 // No início do arquivo, onde carrega o funil
 const savedFunnel = <%- JSON.stringify(funnel) %>;
if (savedFunnel && savedFunnel.nodes && savedFunnel.nodes.length > 0) {
    savedFunnel.nodes.forEach(node => {
        if (node.type !== 'start') {
            const nodeData = {
                id: node.id,
                type: node.type,
                content: node.content,
                position: node.position,
                // Adicione aqui os dados específicos do nó de botões
                title: node.title,
                description: node.description,
                footer: node.footer,
                buttonType: node.buttonType,
                buttons: node.buttons || [], // Importante: inicializar como array vazio se não existir
                // ... outros dados existentes
                ...Object.keys(node).reduce((acc, key) => {
                    if (node[key] !== undefined && 
                        key !== 'id' && 
                        key !== 'type' && 
                        key !== 'position') {
                        acc[key] = node[key];
                    }
                    return acc;
                }, {})
            };

            addNode(node.type, nodeData);
        }
    });

    // Restaurar conexões após todos os nós serem criados
    setTimeout(() => {
        savedFunnel.connections.forEach(conn => {
            createConnection(conn.sourceId, conn.targetId, conn.anchors);
        });
           // Criar conexões para os botões
           nodes.forEach(node => {
            if (node.type === 'buttons' && node.buttonType === 'reply') {
                console.log("restaurando botoes dos botoes")
                console.log( savedFunnel.connections)
                createButtonConnections(node.id, savedFunnel.connections);
            }
        });
        // Atualizar o display de todos os nós
        nodes.forEach(node => {
            updateNodeDisplay(node);
        });
    }, 100);
}
    // Sempre focar no nó de início após carregar
    setTimeout(() => {
        focusOnNode('start_node');
    }, 100);

        // Adicionar evento de zoom com a roda do mouse
        container.addEventListener('wheel', function(e) {
            if (e.ctrlKey) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                zoom(delta);
            }
        });

        // Adicionar eventos para arrastar a tela
        container.addEventListener('mousedown', startDragging);
        container.addEventListener('mousemove', drag);
        container.addEventListener('mouseup', stopDragging);
        container.addEventListener('mouseleave', stopDragging);

        // Atualizar os event listeners dos botões para usar addNewNode
        document.querySelectorAll('.fixed-menu button').forEach(button => {
            const nodeType = button.getAttribute('onclick').match(/addNewNode\('(\w+)'\)/)[1];
            button.removeAttribute('onclick');
            button.addEventListener('click', () => addNewNode(nodeType));
        });

        // Inicialização
        updateCanvasSize();
        centerCanvas();
    });


    function addStartNode() {
    const startNodeId = 'start_node';
    if (document.getElementById(startNodeId)) {
        return; // Se o nó de início já existe, não crie outro
    }

    const canvas = document.getElementById('canvas');
    
    const startNode = {
        id: startNodeId,
        type: 'start',
        content: '',
        position: {
            left: '50px',
            top: '50px'
        }
    };

    const nodeDiv = document.createElement('div');
    nodeDiv.id = startNodeId;
    nodeDiv.className = 'node node-start';
    nodeDiv.style.left = startNode.position.left;
    nodeDiv.style.top = startNode.position.top;
    nodeDiv.style.position = 'absolute';

    nodeDiv.innerHTML = `
        <div class="node-header">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                <path fill-rule="evenodd" d="M4.5 5.653c0-1.426 1.529-2.33 2.779-1.643l11.54 6.348c1.295.712 1.295 2.573 0 3.285L7.28 19.991c-1.25.687-2.779-.217-2.779-1.643V5.653z" clip-rule="evenodd" />
            </svg>
            <span>Start</span>
        </div>
    `;

    canvas.appendChild(nodeDiv);

    jsPlumbInstance.addEndpoint(nodeDiv, {
        anchor: "Right",
        isSource: true,
        isTarget: false,
        maxConnections: -1,
        endpoint: ["Dot", { radius: 5 }],
        paintStyle: { fill: "#4CAF50" },
        connectorStyle: { stroke: "#4CAF50", strokeWidth: 2 },
    });

    jsPlumbInstance.unmakeSource(nodeDiv);
    jsPlumbInstance.unmakeTarget(nodeDiv);

    if (!nodes.some(node => node.id === startNodeId)) {
        nodes.unshift(startNode);
    }

    // Foca no nó inicial
    focusOnNode(startNodeId);
}

function addNewNode(type) {
    const canvas = document.getElementById('canvas');
    const canvasRect = canvas.getBoundingClientRect();
    let newLeft, newTop;

    if (nodes.length > 0) {
        const lastNode = nodes[nodes.length - 1];
        const lastNodeElement = document.getElementById(lastNode.id);
        if (lastNodeElement) {
            const rect = lastNodeElement.getBoundingClientRect();
            newLeft = (rect.right - canvasRect.left + 50) + 'px'; // 50px à direita do último nó
            newTop = (rect.top - canvasRect.top) + 'px';
        } else {
            newLeft = '100px';
            newTop = '100px';
        }
    } else {
        newLeft = '100px';
        newTop = '100px';
    }

    const newNode = addNode(type, { position: { left: newLeft, top: newTop } });
    focusOnNode(newNode.id);
    return newNode;
}

    function addNode(type, data = null) {
        const nodeId = data && data.id ? data.id : `${type}_${Date.now()}`;
    const nodeDiv = document.createElement('div');
    nodeDiv.id = nodeId;
    nodeDiv.className = `node node-${type}`;
    nodeDiv.style.left = data && data.position ? data.position.left : '100px';
    nodeDiv.style.top = data && data.position ? data.position.top : '100px';


    nodeDiv.addEventListener('mouseenter', () => {
        if (jsPlumbInstance.dragging) {
            nodeDiv.classList.add('grouping-target');
        }
    });

    nodeDiv.addEventListener('mouseleave', () => {
        nodeDiv.classList.remove('grouping-target');
    });

    const defaultContent = getDefaultContent(type);
    const newNode2 = {
        id: nodeId,
        type: type,
        content: data && data.content ? data.content : defaultContent,
        typeDelay: data && data.delay && (type === 'message' || type === 'input') ? data.delay : 0,
        recordDelay: data && data.delay && type === 'audio' ? data.delay : 0,
        inputKey: data && data.inputKey ? data.inputKey : '',
        variable: data && data.variable ? data.variable : '',
    conditionType: data && data.conditionType ? data.conditionType : '',
    conditionValue: data && data.conditionValue ? data.conditionValue : '',
    conditionValues: data && data.conditionValues ? data.conditionValues : null,
        position: { left: nodeDiv.style.left, top: nodeDiv.style.top },
        duration: data && data.duration ? data.duration : '',
        groupId: data && data.groupId ? data.groupId : '',
        amount: data && data.amount ? data.amount : '',
        description: data && data.description ? data.description : '',
        paymentId: data && data.paymentId ? data.paymentId : '',
        timeout: data && data.timeout ? data.timeout : 15, // Usa o valor salvo ou o padrão
        paymentToCheck: data && data.paymentToCheck ? data.paymentToCheck : '',
        caption: data && data.caption ? data.caption : '',
        messages: data && data.messages ? data.messages : [],
        aiPrompt: data && data.aiPrompt ? data.aiPrompt : '',
        aiMemoryId: data && data.aiMemoryId ? data.aiMemoryId : '',
        aiSystemInstruction: data && data.aiSystemInstruction ? data.aiSystemInstruction : '',
        aiConditionPrompt: data && data.aiConditionPrompt ? data.aiConditionPrompt : '',
        aiConditionVariable: data && data.aiConditionVariable ? data.aiConditionVariable : '',
        apiUrl: data && data.apiUrl ? data.apiUrl : '',
        requestType: data && data.requestType ? data.requestType : 'GET',
        requestBody: data && data.requestBody ? data.requestBody : '',
        requestHeaders: data && data.requestHeaders ? data.requestHeaders : '',
        responseVariable: data && data.responseVariable ? data.responseVariable : '',
        selectedFields: data && data.selectedFields ? data.selectedFields : [],
        videoFile: data && data.videoFile ? data.videoFile : null,
        videoName: data && data.videoName ? data.videoName : '',
        videoUrl: data && data.videoUrl ? data.videoUrl : '',
        caption: data && data.caption ? data.caption : '',
        stickerUrl: data && data.stickerUrl ? data.stickerUrl : '',
        duration: data && data.duration ? data.duration : 5,
        isVideo: data && data.isVideo !== undefined ? data.isVideo : false,
        latitude: data && data.latitude ? data.latitude : '',
        longitude: data && data.longitude ? data.longitude : '',
        address: data && data.address ? data.address : '',
     
    };

    
    if (type === 'buttons') {
        newNode2.title = data?.title || '';
        newNode2.description = data?.description || '';
        newNode2.footer = data?.footer || '';
        newNode2.buttonType = data?.buttonType || 'reply';
        newNode2.buttons = data?.buttons || [];
    }

    if (type === 'buttons' && data.buttonType === 'reply') {
    // Endpoint de entrada (lado esquerdo)
    jsPlumbInstance.addEndpoint(nodeDiv, {
        anchor: "Left",
        isSource: false,
        isTarget: true,
        maxConnections: -1,
        endpoint: ["Dot", { radius: 4 }],
        paintStyle: { fill: "#6366F1" }
    });

    // Verifica se há botões
    if (data.buttons) {
        // Contêiner para os botões
    
        // Adiciona cada botão ao contêiner de botões
        const buttonListContainer = document.createElement('div');
buttonListContainer.className = 'button-list-container';

// Adiciona cada botão ao container
data.buttons.forEach((button, index) => {
    const buttonElement = document.createElement('div');
    buttonElement.className = 'button-container';
    buttonElement.id = `button-${data.id}-${index}`;
    buttonElement.innerHTML = `
        <span class="button-text">${button.displayText}</span>
        <div class="button-endpoint"></div>
    `;
    
    buttonListContainer.appendChild(buttonElement);

    // Configura endpoint para cada botão após a página carregar completamente
    setTimeout(() => {
        jsPlumbInstance.addEndpoint(buttonElement.querySelector('.button-endpoint'), {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#48BB78" }
        });
    }, 100); // Pequeno atraso para renderizar
});

        // Adiciona o contêiner de botões ao nodeDiv
        nodeDiv.appendChild(buttonListContainer);
    }
}

// Adicione os estilos CSS necessários
const styles = document.createElement('style');
styles.textContent = `
.button-endpoint {
    position: relative;
    margin: 5px 0;
    padding: 5px 10px;
    background-color: #f3f4f6;
    border-radius: 4px;
    cursor: pointer;
}

.button-label {
    font-size: 12px;
    color: #374151;
}

.button-endpoint:hover {
    background-color: #e5e7eb;
}
`;
document.head.appendChild(styles);

    let nodeContent = `
        <div class="node-header">
            <span>${nodeIcons[type] || ''} ${getNodeTitle(type)}</span>
            <div>
                <button onclick="editNode('${nodeId}')" class="text-blue-500 hover:text-blue-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                 <button onclick="duplicateNode('${nodeId}')" class="text-gray-500 hover:text-gray-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
                </svg>
            </button>
                <button onclick="deleteNode('${nodeId}')" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        </div>
        <div class="node-content" id="content_${nodeId}">
            ${getNodeContent(type, newNode2)}
        </div>
        <div class="node-footer">
            <span class="text-xs text-gray-500">ID: ${nodeId}</span>
        </div>
    `;


    if (type === 'randomPath') {
        // Adiciona múltiplos endpoints de saída à direita
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Left",
            isSource: false,
            isTarget: true,
            maxConnections: -1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#6366F1" }
        });

        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: -1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#6366F1" }
        });
    }

    if (type !== 'start') {
        nodeContent += `
            <div>
                <button onclick="editNode('${nodeId}')" class="text-blue-500 hover:text-blue-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                    </svg>
                </button>
                <button onclick="deleteNode('${nodeId}')" class="text-red-500 hover:text-red-700">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                </button>
            </div>
        `;
    }


    if (type === 'aiAgent') {
        const shortId = `AI_${nodeId.substr(-4)}`;
        newNode2.shortId = shortId;
        newNode2.aiResponseVariable = `{{${shortId}}}`;
    }

    if (type === 'nameExtractor') {
    const shortId = `extractedName_${nodeId.substr(-4)}`;
    newNode2.shortId = shortId;
    newNode2.outputVariable = shortId;
    newNode2.aiPrompt = data && data.aiPrompt ? data.aiPrompt : '';
}


    nodeDiv.innerHTML = nodeContent;
    document.getElementById('canvas').appendChild(nodeDiv);


        jsPlumbInstance.draggable(nodeDiv, {
            grid: [10, 10],
            containment: 'parent'
        });
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: -1
        });
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Left",
            isSource: false,
            isTarget: true,
            maxConnections: -1
        });

        if (type === 'condition' || type === 'checkPayment') {
            jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Bottom",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            cssClass: "endpoint-no",
            overlays: [
                ["Label", { 
                    label: "Não", 
                    location: [0.5, 1.5],
                    cssClass: "endpoint-label"
                }]
            ]
        });
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            cssClass: "endpoint-yes",
            overlays: [
                ["Label", { 
                    label: "Sim", 
                    location: [1.5, 0.5],
                    cssClass: "endpoint-label"
                }]
            ]
        });
    } else {

        if (type === 'generatePayment') {
        // Remove endpoints existentes para o nó
        jsPlumbInstance.removeAllEndpoints(nodeDiv);
        
        // Endpoint de entrada (lado esquerdo)
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Left",
            isSource: false,
            isTarget: true,
            maxConnections: 1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#6366F1" }
        });

        // Endpoint de sucesso (lado direito - verde)
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#10B981" }, // Verde
            connectorStyle: { stroke: "#10B981", strokeWidth: 2 },
            overlays: [
                ["Label", { 
                    label: "Pago",
                    location: [1.5, 0.5],
                    cssClass: "endpoint-label",
                    id: "paid-label"
                }]
            ]
        });

        // Endpoint de timeout (baixo - vermelho)
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Bottom",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#EF4444" }, // Vermelho
            connectorStyle: { stroke: "#EF4444", strokeWidth: 2 },
            overlays: [
                ["Label", { 
                    label: "Não Pago",
                    location: [0.5, 1.5],
                    cssClass: "endpoint-label",
                    id: "unpaid-label"
                }]
            ]
        });

        const styles = document.createElement('style');
    styles.textContent = `
        .endpoint-label {
            font-size: 12px;
            font-weight: bold;
            color: white;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.7);
        }
        
        .jtk-endpoint.paid-endpoint {
            cursor: pointer;
        }
        
        .jtk-endpoint.unpaid-endpoint {
            cursor: pointer;
        }
        
        .payment-node .node-footer {
            margin-bottom: 20px; /* Espaço extra para o endpoint inferior */
        }
    `;
    document.head.appendChild(styles);

    } else {
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: -1
        });
        jsPlumbInstance.addEndpoint(nodeDiv, {
            anchor: "Left",
            isSource: false,
            isTarget: true,
            maxConnections: -1
        });
    }
      
    }

       

        nodes.push(newNode2);
        updateNodeDisplay(newNode2);

        if (['image', 'audio', 'video'].includes(type)) {
        const mediaPreview = document.createElement('div');
        mediaPreview.className = 'media-preview mt-2';
        mediaPreview.id = `preview_${nodeId}`;
        nodeDiv.querySelector('.node-content').appendChild(mediaPreview);
        
        // Atualizar preview imediatamente se houver dados
        if (data && data.content) {
            updateMediaPreviewRealTime(nodeId, data.content);
        }
    }


        onNodeChange();

        return newNode2;
    }


    function createButtonConnections(nodeId, connections) {
    const node = nodes.find(n => n.id === nodeId);
    if (!node || !node.buttons) return;

    node.buttons.forEach((button, index) => {
        const buttonElementId = `button-${nodeId}-${index}`;
        const buttonElement = document.getElementById(buttonElementId);
        if (!buttonElement) return;

        // Adicionar endpoint para o botão
        jsPlumbInstance.addEndpoint(buttonElement, {
            anchor: "Right",
            isSource: true,
            isTarget: false,
            maxConnections: 1,
            endpoint: ["Dot", { radius: 4 }],
            paintStyle: { fill: "#48BB78" }
        });

        // Encontrar conexão correspondente
        const connection = connections.find(conn => 
            conn.sourceId === buttonElementId
        );

        if (connection) {
            jsPlumbInstance.connect({
                source: buttonElement,
                target: connection.targetId,
                anchor: ["Right", "Left"],
                endpoint: ["Dot", { radius: 4 }],
                paintStyle: { stroke: "#48BB78", strokeWidth: 2 },
                connector: ["Flowchart", { cornerRadius: 5 }]
            });
        }
    });
}


function getNodeTitle(type) {
    const titles = {
        message: 'Mensagem',
        input: 'Input',
        condition: 'Condição',
        wait: 'Espera',
        image: 'Imagem',
        audio: 'Áudio',
        video: 'Vídeo',
        file: 'Arquivo',
        typing: 'Digitando',
        recordAudio: 'Gravando Áudio',
        addToGroup: 'Adicionar ao Grupo',
        removeFromGroup: 'Remover do Grupo',
        sendFile: 'Enviar Arquivo',
        visualize: 'Visualizar',
        randomMessage: 'Mensagens Aleatórias',
        apiRequest: 'Requisição API',
        aiAgent: 'Agente de IA',
        nameExtractor: 'Extrator de Nomes',
        aiCondition: 'Condição com IA',
        location: "Localização",
        fakeCall: "Chamada Fake",
        videoMessage: "Recado de Vídeo",
        stickerMessage: "Figurinha",
        generatePayment: 'Gerar Pagamento',
        checkPayment: 'Verificar Pagamento',
        collectNumber: 'Coletar Número',
        savePurchaseEvent: 'Salvar Compra',
        sendToOtherNumber: 'Enviar para Outro Número',
        randomPath: 'Randomizar Caminhos',
        buttons: "Mensagem com Botão"
    };
    return titles[type] || 'Nó';
}

function getNodeContent(type, data) {
    if (data) {
        switch (type) {
            case 'nameExtractor':
                return `<p>Extrai nome de: ${data.inputVariable || 'Não definido'}</p><p>Salva em: ${data.outputVariable || 'Não definido'}</p>`;
                case 'randomPath':
            const connections = data.connections || [];
            return `
                <div class="p-2">
                    <p class="text-sm font-medium text-gray-700">Caminhos Disponíveis: ${connections.length}</p>
                    <p class="text-xs text-gray-500 mt-1">Um caminho será escolhido aleatoriamente</p>
                </div>
            `;
            case 'buttons':
    return `
        <div class="p-2">
            <p class="text-sm font-medium text-gray-700">Mensagem com Botões</p>
            <p class="text-xs text-gray-500 mt-1">Título: ${data.title || 'Não definido'}</p>
            <p class="text-xs text-gray-500">Botões: ${data.buttons?.length || 0}/4</p>
        </div>`;

            case 'videoMessage':
            return `<p>Video: ${data.content || 'URL do Vídeo'}</p>`;

            case 'stickerMessage':
                return `
                    <div class="p-2">
                        <p class="text-sm font-medium text-gray-700">Figurinha</p>
                        ${data.stickerUrl ?
                            `<p class="text-xs text-green-600 mt-1">✓ URL configurada</p>
                             <div class="mt-2 w-16 h-16 rounded border">
                                <img src="${data.stickerUrl}" class="w-full h-full object-contain" 
                                     onerror="this.src='/path/to/fallback-image.png'">
                             </div>` :
                            '<p class="text-xs text-gray-500 mt-1">Nenhuma URL configurada</p>'
                        }
                    </div>`;

            case 'fakeCall':
                return `
                    <div class="p-2">
                        <p class="text-sm font-medium text-gray-700">Chamada Fake</p>
                        <p class="text-xs text-gray-600 mt-1">
                            Tipo: ${data.isVideo ? 'Vídeo' : 'Voz'}<br>
                            Duração: ${data.duration || 5} segundos
                        </p>
                    </div>`;

            case 'location':
                return `
                    <div class="p-2">
                        <p class="text-sm font-medium text-gray-700">Enviar Localização</p>
                        ${data.address ?
                            `<p class="text-xs text-gray-600 mt-1">
                                Local: ${data.address}<br>
                                Coords: ${data.latitude}, ${data.longitude}
                             </p>
                             <div class="mt-2 text-xs bg-blue-50 p-2 rounded">
                                <p class="font-medium text-blue-700">✓ Localização configurada</p>
                             </div>` :
                            '<p class="text-xs text-gray-500 mt-1">Localização não configurada</p>'
                        }
                    </div>`;
            case 'message':
                return `<p>${data.content || 'Nova mensagem'}</p>`;
            case 'input':
                return `<p>${data.content || 'Digite sua pergunta'} (${data.inputKey || 'Sem chave'})</p>`;
            case 'condition':
                return `<p>Se ${data.inputKey || 'input'} ${data.conditionType || 'equals'} "${data.conditionValue || ''}"</p>`;
            case 'wait':
                return `<p>Esperar ${data.content || '5'} segundos</p>`;
            case 'image':
                return `<p>Imagem: ${data.content || 'URL da imagem'}</p><p>Legenda: ${data.caption || ''}</p>`;
            case 'audio':
                return `<p>Áudio: ${data.content || 'URL do áudio'}</p>`;
            case 'video':
                return `<p>Vídeo: ${data.content || 'URL do vídeo'}</p><p>Legenda: ${data.caption || ''}</p>`;
            case 'randomMessage':
                return `<p>Mensagens aleatórias: ${data.messages ? data.messages.length : 0}</p>`;
                case 'collectNumber':
                    return `<p>Coletar número atual do chat</p>`;
                case 'savePurchaseEvent':
                    return `<p>Salvar evento: ${data.eventType || 'Não definido'}</p>`;
                case 'sendToOtherNumber':
                    return `<p>Enviar ${data.messageType || 'mensagem'} para: ${data.targetNumber || 'Não definido'}</p>`;
 

                

                case 'apiRequest':
    let selectedFieldsHtml = '';
    if (data.selectedFields && data.selectedFields.length > 0) {
        selectedFieldsHtml = '<p>Campos selecionados:</p><ul>' +
            data.selectedFields.map(field => `<li>${field}</li>`).join('') +
            '</ul>';
    }
    return `<p>URL: ${data.apiUrl ? data.apiUrl.substring(0, 50) + '...' : 'Não definida'}</p>${selectedFieldsHtml}`;
    case 'aiCondition':
                return `<p>Condição IA: ${data.aiConditionPrompt || 'Não definida'}</p>`;
            case 'generatePayment':
                return `<p>Gerar pagamento: R$ ${data.amount || '0'}</p>`;
            case 'checkPayment':
                return `<p>Verificar pagamento: ${data.paymentToCheck || 'Não selecionado'}</p>`;
            // Adicione outros casos conforme necessário
            default:
                return `<p>${data.content || 'Novo conteúdo'}</p>`;
        }
    }
    return '<p>Clique para editar</p>';
}


function duplicateNode(nodeId) {
    const originalNode = nodes.find(n => n.id === nodeId);
    if (!originalNode) return;

    const newNode = JSON.parse(JSON.stringify(originalNode));
    newNode.id = `${newNode.type}_${Date.now()}`;
    newNode.position = {
        left: (parseInt(originalNode.position.left) + 50) + 'px',
        top: (parseInt(originalNode.position.top) + 50) + 'px'
    };

    addNode(newNode.type, newNode);
    focusOnNode(newNode.id);
}

document.addEventListener('keydown', function(e) {
    if (e.ctrlKey || e.metaKey) {
        switch (e.key) {
            case 's':
                e.preventDefault();
                saveFunnel();
                break;
            case 'z':
                e.preventDefault();
                // Implementar função de desfazer
                break;
            case 'y':
                e.preventDefault();
                // Implementar função de refazer
                break;
            case 'd':
                e.preventDefault();
                if (editingNodeId) {
                    duplicateNode(editingNodeId);
                }
                break;
        }
    }
});

function getDefaultContent(type) {
    const defaults = {
        message: 'Nova mensagem',
        input: 'Digite sua pergunta',
        condition: 'Condição',
        wait: '5',
        image: 'URL da imagem',
        audio: 'URL do áudio',
        video: 'URL do vídeo',
        file: 'URL do arquivo',
        randomMessage: [],
        apiRequest: { url: '', method: 'GET', body: '' },
        aiAgent: { prompt: '', memoryId: '' },
        aiCondition: { systemInstruction: '', prompt: '', variable: '' },
        generatePayment: { amount: 0, description: '' },
        checkPayment: { paymentToCheck: '' }
    };
    return defaults[type] || '';
}

    
    function getPaymentOptions() {
    return nodes
        .filter(n => n.type === 'generatePayment' && n.paymentId)
        .map(n => `<option value="${n.paymentId}">${n.paymentId} - R$ ${n.amount} - ${n.description || 'Sem descrição'}</option>`)
        .join('');
}


function addMessageInput() {
    const messageList = document.getElementById('messageList');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'messageInput w-full p-2 border rounded mt-2';
    messageList.appendChild(input);
}


async function testApiRequest() {
    const url = document.getElementById('apiUrl').value;
    const method = document.getElementById('requestType').value;
    const body = document.getElementById('requestBody').value;
    const headers = document.getElementById('requestHeaders').value;

    try {
        const response = await fetch('/test-api-request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url, method, body, headers })
        });
        const data = await response.json();
        
        let resultHtml = '';
        if (data.success) {
            resultHtml = `
                <h3 class="text-lg font-semibold mb-2">Resposta da API:</h3>
                <p><strong>Status:</strong> ${data.status} ${data.statusText}</p>
                <h4 class="font-semibold mt-2">Dados:</h4>
                <pre class="bg-gray-100 p-2 rounded mt-1 overflow-auto max-h-40">${JSON.stringify(data.data, null, 2)}</pre>
                <h4 class="font-semibold mt-4">Selecione os campos para usar como variáveis:</h4>
                <div id="apiDataFields" class="mt-2">
                    ${generateApiDataFields(data.data)}
                </div>
            `;
        } else {
            resultHtml = `
                <h3 class="text-lg font-semibold mb-2 text-red-600">Erro na requisição:</h3>
                <p>${data.error}</p>
                ${data.response ? `
                    <p><strong>Status:</strong> ${data.response.status} ${data.response.statusText}</p>
                    <h4 class="font-semibold mt-2">Resposta do servidor:</h4>
                    <pre class="bg-gray-100 p-2 rounded mt-1 overflow-auto max-h-40">${JSON.stringify(data.response.data, null, 2)}</pre>
                ` : ''}
            `;
        }

        document.getElementById('apiResponse').innerHTML = resultHtml;
        document.getElementById('apiResponse').classList.remove('hidden');
    } catch (error) {
        console.error('Erro ao testar requisição:', error);
        document.getElementById('apiResponse').innerHTML = `<p class="text-red-600">Erro ao enviar requisição: ${error.message}</p>`;
        document.getElementById('apiResponse').classList.remove('hidden');
    }
}

function generateApiDataFields(data, prefix = '') {
    let html = '';
    for (const [key, value] of Object.entries(data)) {
        const fullKey = prefix ? `${prefix}.${key}` : key;
        if (typeof value === 'object' && value !== null) {
            html += generateApiDataFields(value, fullKey);
        } else {
            html += `
                <div class="flex items-center mt-1">
                    <input type="checkbox" id="${fullKey}" name="apiDataField" value="${fullKey}" class="mr-2">
                    <label for="${fullKey}">${fullKey}: ${value}</label>
                </div>
            `;
        }
    }
    return html;
}

function generateApiDataFields(data, prefix = '') {
    let html = '';
    for (const [key, value] of Object.entries(data)) {
        const fullKey = prefix ? `${prefix}.${key}` : key;
        if (typeof value === 'object' && value !== null) {
            html += generateApiDataFields(value, fullKey);
        } else {
            html += `
                <div class="flex items-center mt-1">
                    <input type="checkbox" id="${fullKey}" name="apiDataField" value="${fullKey}" class="mr-2">
                    <label for="${fullKey}">${fullKey}: ${value}</label>
                </div>
            `;
        }
    }
    return html;
}

function truncateUrl(url, maxLength = 30) {
    if (!url) return '';
    if (url.length <= maxLength) return url;
    
    const start = url.substring(0, maxLength/2);
    const end = url.substring(url.length - maxLength/2);
    return `${start}...${end}`;
}

function updateMediaPreviewRealTime(nodeId, url) {
    const nodeContent = document.getElementById(`content_${nodeId}`);
    if (!nodeContent) return;

    // Procura pelo preview existente ou cria um novo
    let previewElement = document.getElementById(`preview_${nodeId}`);
    if (!previewElement) {
        previewElement = document.createElement('div');
        previewElement.id = `preview_${nodeId}`;
        previewElement.className = 'media-preview mt-2';
        nodeContent.appendChild(previewElement);
    }

    if (!url) {
        previewElement.innerHTML = '';
        return;
    }

    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;

    // Limpar preview anterior
    previewElement.innerHTML = '';

    // Criar novo elemento de preview baseado no tipo
    try {
        switch (node.type) {
            case 'image':
                const img = new Image();
                img.src = url;
                img.classList.add('media-preview');
                img.onerror = () => {
                    previewElement.innerHTML = '<p class="text-red-500">Erro ao carregar imagem</p>';
                };
                img.onload = () => {
                    previewElement.innerHTML = '';
                    previewElement.appendChild(img);
                };
                break;
            case 'video':
                const video = document.createElement('video');
                video.src = url;
                video.controls = true;
                video.classList.add('media-preview');
                video.onerror = () => {
                    previewElement.innerHTML = '<p class="text-red-500">Erro ao carregar vídeo</p>';
                };
                previewElement.appendChild(video);
                break;
            case 'audio':
                const audio = document.createElement('audio');
                audio.src = url;
                audio.controls = true;
                audio.classList.add('media-preview');
                audio.onerror = () => {
                    previewElement.innerHTML = '<p class="text-red-500">Erro ao carregar áudio</p>';
                };
                previewElement.appendChild(audio);
                break;
        }
    } catch (error) {
        console.error('Erro ao atualizar preview:', error);
        previewElement.innerHTML = '<p class="text-red-500">Erro ao carregar mídia</p>';
    }
}

function insertVariableToApiFields() {
    const select = document.getElementById('variableSelect');
    const url = document.getElementById('apiUrl');
    const body = document.getElementById('requestBody');
    const headers = document.getElementById('requestHeaders');
    
    if (select.value) {
        const placeholder = `{{${select.value}}}`;
        
        // Pergunte ao usuário onde inserir a variável
        Swal.fire({
            title: 'Onde inserir a variável?',
            input: 'radio',
            inputOptions: {
                url: 'URL',
                body: 'Corpo da requisição',
                headers: 'Headers'
            },
            inputValidator: (value) => {
                if (!value) {
                    return 'Você precisa escolher uma opção!';
                }
            }
        }).then((result) => {
            if (result.isConfirmed) {
                switch (result.value) {
                    case 'url':
                        insertAtCursor(url, placeholder);
                        break;
                    case 'body':
                        insertAtCursor(body, placeholder);
                        break;
                    case 'headers':
                        insertAtCursor(headers, placeholder);
                        break;
                }
            }
        });
    }
}

const getVariableOptions = (nodes: any[] = []) => {
  if (!nodes || !Array.isArray(nodes)) return [];

  return [
    ...nodes
      .filter(n => n.type === 'input' && n.data?.saveResponse)
      .map(n => ({
        value: `input:${n.data.inputKey}`,
        label: `${n.data.inputKey} (Input)`
      })),
    ...nodes
      .filter(n => n.type === 'nameExtractor' && n.data?.shortId)
      .map(n => ({
        value: `nameExtractor:${n.data.shortId}`,
        label: `${n.data.shortId} (Nome Extraído)`
      }))
  ]
    .filter(Boolean)
    .map(option => 
      `<option value="${option.value}">${option.label}</option>`
    )
    .join('');
};

function insertVariable(targetId) {
    const select = document.getElementById('variableSelect');
    const textarea = document.getElementById(targetId);
    if (select.value) {
        const placeholder = `{{${select.value}}}`;
        insertAtCursor(textarea, placeholder);
    }
}

// Adicione ao script existente

function initializeDragAndDrop() {
    const menuItems = document.querySelectorAll('.menu-item');
    
    menuItems.forEach(item => {
        item.setAttribute('draggable', 'true');
        
        item.addEventListener('dragstart', (e) => {
            e.dataTransfer.setData('nodeType', item.getAttribute('data-type'));
            e.dataTransfer.effectAllowed = 'move';
            
            // Adiciona classe visual durante o arrasto
            item.classList.add('dragging');
        });

        item.addEventListener('dragend', (e) => {
            item.classList.remove('dragging');
        });
    });

    const canvas = document.getElementById('canvas');
    
    canvas.addEventListener('dragover', (e) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
    });

    canvas.addEventListener('drop', (e) => {
        e.preventDefault();
        const nodeType = e.dataTransfer.getData('nodeType');
        
        // Calcula a posição do drop considerando o scroll e zoom
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.offsetWidth / rect.width;
        const scaleY = canvas.offsetHeight / rect.height;
        
        const x = (e.clientX - rect.left) * scaleX;
        const y = (e.clientY - rect.top) * scaleY;

        // Cria o novo nó na posição do drop
        addNode(nodeType, {
            position: {
                left: `${x}px`,
                top: `${y}px`
            }
        });
    });
}

    function editNode(nodeId) {
        const node = nodes.find(n => n.id === nodeId);
        if (!node) return;

        editingNodeId = nodeId;
        document.getElementById('modalTitle').textContent = `Editar ${getNodeTitle(node.type)}`;
        let content = '';

        switch (node.type) {
            case 'buttons':
    content = `
    <div class="space-y-4">
        <div>
            <label class="block text-sm font-medium text-gray-700">Título</label>
            <input type="text" id="buttonTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                value="${node.title || ''}" placeholder="Título da mensagem">
        </div>
        
        <div>
            <label class="block text-sm font-medium text-gray-700">Descrição</label>
            <textarea id="buttonDescription" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                rows="2" placeholder="Descrição da mensagem">${node.description || ''}</textarea>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Rodapé</label>
            <input type="text" id="buttonFooter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                value="${node.footer || ''}" placeholder="Texto do rodapé">
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700">Tipo dos Botões</label>
            <select id="buttonType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                onchange="updateButtonFields()">
            
                <option value="copy" ${node.buttonType === 'copy' ? 'selected' : ''}>Copiar</option>
                <option value="url" ${node.buttonType === 'url' ? 'selected' : ''}>URL</option>
                <option value="call" ${node.buttonType === 'call' ? 'selected' : ''}>Chamada</option>
                <option value="pix" ${node.buttonType === 'pix' ? 'selected' : ''}>PIX</option>
            </select>
        </div>

        <div id="buttonsList" class="space-y-4">
            ${generateButtonInputs(node)}
        </div>

        <button onclick="addButton()" 
            class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400"
            id="addButtonBtn">
            Adicionar Botão
        </button>
    </div>`;
    break;
            case 'videoMessage':
            title = 'Configurar Recado de Vídeo';
            content = `
               <div>
            <label for="nodeContent" class="block text-sm font-medium text-gray-700 mb-1">LINK DA MIDIA</label>
            <textarea id="nodeContent" class="w-full p-2 border rounded" rows="4">${node.content}</textarea>
        </div>
       
        <div class="mt-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
            <div class="flex items-center space-x-2">
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
                <button onclick="insertVariable('nodeContent')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Inserir
                </button>
            </div>
        </div>`;
            break;

        case 'stickerMessage':
            title = 'Configurar Figurinha';
            content = `
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="block text-sm font-medium text-gray-700">URL da Imagem</label>
                        <input type="text" 
                               id="stickerUrl" 
                               class="mt-1 block w-full rounded-md border-gray-300 shadow-sm"
                               value="${node.stickerUrl || ''}"
                               placeholder="https://exemplo.com/imagem.jpg"
                               onchange="updateStickerPreview(this.value)">
                    </div>
                    <div id="stickerPreview" class="${node.stickerUrl ? '' : 'hidden'} mt-4">
                        <img src="${node.stickerUrl || ''}" 
                             class="w-32 h-32 object-contain rounded-lg shadow-lg" 
                             alt="Preview da figurinha">
                    </div>
                    <p class="text-sm text-gray-500">
                        A imagem será automaticamente convertida em figurinha.
                        Formatos suportados: JPG, PNG
                    </p>
                </div>`;
            break;

        case 'fakeCall':
            title = 'Configurar Chamada Fake';
            content = `
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="block text-sm font-medium text-gray-700">Duração da Chamada</label>
                        <div class="mt-1 flex items-center space-x-2">
                            <input type="range" 
                                   id="callDuration" 
                                   class="flex-1"
                                   min="1" 
                                   max="15" 
                                   value="${node.duration || 5}"
                                   oninput="document.getElementById('durationValue').textContent = this.value">
                            <span id="durationValue" class="text-sm font-medium w-12 text-center">
                                ${node.duration || 5}
                            </span>
                            <span class="text-sm text-gray-500">seg</span>
                        </div>
                    </div>
                    <div class="form-control">
                        <label class="flex items-center space-x-3 cursor-pointer">
                            <input type="checkbox" 
                                   id="isVideoCall" 
                                   class="rounded border-gray-300 text-blue-600 shadow-sm"
                                   ${node.isVideo ? 'checked' : ''}>
                            <span class="text-sm font-medium text-gray-700">Chamada de Vídeo</span>
                        </label>
                    </div>
                    <div class="bg-blue-50 p-3 rounded-md">
                        <p class="text-sm text-blue-700">
                            ℹ️ A chamada será simulada por no máximo 15 segundos.
                        </p>
                    </div>
                </div>`;
            break;

        case 'location':
            title = 'Configurar Localização';
            content = `
                <div class="space-y-4">
                    <div class="form-control">
                        <label class="block text-sm font-medium text-gray-700">Buscar Local</label>
                        <div class="mt-1 flex space-x-2">
                            <input type="text" 
                                   id="locationInput" 
                                   class="flex-1 rounded-md border-gray-300 shadow-sm"
                                   placeholder="Digite um endereço ou CEP"
                                   value="${node.address || ''}">
                            <button onclick="searchLocation()" 
                                    class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                Buscar
                            </button>
                        </div>
                    </div>
                    <div id="locationPreview" class="${node.address ? '' : 'hidden'} mt-4">
                        <div class="p-4 bg-gray-50 rounded-lg">
                            <h4 class="text-sm font-medium text-gray-700">Local Encontrado:</h4>
                            <p id="locationAddress" class="text-sm text-gray-600 mt-1">
                                ${node.address || ''}
                            </p>
                            <p class="text-xs text-gray-500 mt-2">
                                Coordenadas: ${node.latitude || ''}, ${node.longitude || ''}
                            </p>
                            <input type="hidden" id="latitude" value="${node.latitude || ''}">
                            <input type="hidden" id="longitude" value="${node.longitude || ''}">
                        </div>
                    </div>
                </div>`;
            break;
            case 'collectNumber':
                content = `
                    <p>Este nó coleta o número atual do chat e o salva para uso posterior.</p>
                `;
                break;
                case 'randomPath':
            // Conte o número de conexões de saída
            const connections = jsPlumbInstance.getConnections({ source: nodeId });
            content = `
                <div class="p-4 space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-900">Configuração de Caminhos Aleatórios</h3>
                        <p class="mt-2 text-sm text-gray-600">
                            Este nó permite criar múltiplos caminhos de saída. Um deles será escolhido aleatoriamente durante a execução.
                        </p>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700">Caminhos conectados: ${connections.length}</p>
                            <p class="text-xs text-gray-500 mt-1">Conecte mais nós para adicionar caminhos possíveis.</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 bg-yellow-50 p-4 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">
                            Cada vez que este nó for executado, um caminho diferente pode ser escolhido.
                        </p>
                    </div>
                </div>
            `;
            break;
                case 'nameExtractor':
    content = `
        <div class="form-control">
            <label class="label">
                <span class="label-text">Prompt para extração de nome</span>
            </label>
            <textarea id="aiPrompt" class="w-full p-2 border rounded mb-2" rows="4" placeholder="Digite o prompt para extrair o nome">${node.aiPrompt || ''}</textarea>
        </div>
        <div class="form-control mt-4">
            <label class="label">
                <span class="label-text">Variável de saída (nome extraído)</span>
            </label>
            <input type="text" id="outputVariable" class="input input-bordered" value="${node.outputVariable || ''}">
        </div>
        <div class="flex items-center space-x-2 mt-2">
            <div class="flex-grow">
                <label for="variableSelect" class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
            </div>
            <button onclick="insertVariable('aiPrompt')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mt-6">
                Inserir
            </button>
        </div>
    `;
    break;
            case 'savePurchaseEvent':
                content = `
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Tipo de Evento</span>
                        </label>
                        <select id="eventType" class="select select-bordered w-full">
                            <option value="pixGenerated">Pix Gerado</option>
                            <option value="paymentCompleted">Pagamento Realizado</option>
                            <option value="paymentFailed">Pagamento Não Realizado</option>
                        </select>
                    </div>
                `;
                break;
            case 'sendToOtherNumber':
                content = `
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text">Número Alvo</span>
                        </label>
                        <input type="text" id="targetNumber" class="input input-bordered" value="${node.targetNumber || ''}">
                    </div>
                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Tipo de Mensagem</span>
                        </label>
                        <select id="messageType" class="select select-bordered w-full">
                            <option value="text">Texto</option>
                            <option value="image">Imagem</option>
                            <option value="video">Vídeo</option>
                            <option value="audio">Áudio</option>
                        </select>
                    </div>
                    <div class="form-control mt-4">
                        <label class="label">
                            <span class="label-text">Conteúdo da Mensagem</span>
                        </label>
                        <textarea id="messageContent" class="textarea textarea-bordered h-24">${node.messageContent || ''}</textarea>
                    </div>
                `;
                break;
            case 'aiAgent':
    content = `
        <textarea id="aiPrompt" class="w-full p-2 border rounded mb-2" rows="4" placeholder="Prompt para a IA">${node.aiPrompt || ''}</textarea>
        <input type="text" id="aiMemoryId" class="w-full p-2 border rounded mb-2" placeholder="ID da memória" value="${node.aiMemoryId || ''}">
        <div class="flex items-center space-x-2 mt-2">
            <div class="flex-grow">
                <label for="variableSelect" class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
            </div>
            <button onclick="insertVariable('aiPrompt')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mt-6">
                Inserir
            </button>
        </div>
    `;
    break;

case 'aiCondition':
    content = `
        <textarea id="aiSystemInstruction" class="w-full p-2 border rounded mb-2" rows="4" placeholder="Instruções do sistema para a IA">${node.aiSystemInstruction || ''}</textarea>
        <textarea id="aiConditionPrompt" class="w-full p-2 border rounded mb-2" rows="4" placeholder="Prompt para a condição IA">${node.aiConditionPrompt || ''}</textarea>
        <input type="text" id="aiConditionVariable" class="w-full p-2 border rounded mb-2" placeholder="Variável para armazenar resultado" value="${node.aiConditionVariable || ''}">
        <div class="flex items-center space-x-2 mt-2">
            <div class="flex-grow">
                <label for="variableSelect" class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
            </div>
            <button onclick="insertVariable('aiConditionPrompt')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mt-6">
                Inserir
            </button>
        </div>
    `;
    break;
    case 'apiRequest':
    let headersJson = '{}';
    if (node.headers) {
        try {
            headersJson = JSON.stringify(node.headers, null, 2)
                .replace(/'/g, '"')  // Substitui aspas simples por aspas duplas
                .replace(/([{,]\s*)(\w+):/g, '$1"$2":');  // Adiciona aspas aos nomes das propriedades
        } catch (error) {
            console.error('Erro ao formatar headers:', error);
        }
    }
    content = `
        <div>
            <label for="requestType" class="block text-sm font-medium text-gray-700 mb-1">Método</label>
            <select id="requestType" class="w-full p-2 border rounded mb-2">
                <option value="GET" ${node.requestType === 'GET' ? 'selected' : ''}>GET</option>
                <option value="POST" ${node.requestType === 'POST' ? 'selected' : ''}>POST</option>
                <option value="PUT" ${node.requestType === 'PUT' ? 'selected' : ''}>PUT</option>
                <option value="DELETE" ${node.requestType === 'DELETE' ? 'selected' : ''}>DELETE</option>
            </select>
        </div>
        <div>
            <label for="apiUrl" class="block text-sm font-medium text-gray-700 mb-1">URL da API</label>
            <textarea id="apiUrl" class="w-full p-2 border rounded mb-2" placeholder="URL da API" rows="2">${node.apiUrl || ''}</textarea>
        </div>
        <div>
            <label for="requestHeaders" class="block text-sm font-medium text-gray-700 mb-1">
                Headers (JSON)
                <button type="button" onclick="showHeadersHelp()" class="ml-2 text-sm text-blue-600 hover:text-blue-800">
                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                </button>
            </label>
                <textarea id="requestHeaders" class="w-full p-2 border rounded mb-2" placeholder="Headers em formato JSON" rows="3">${headersJson}</textarea>
                <button type="button" onclick="formatHeaders()" class="mt-1 text-sm text-blue-600 hover:text-blue-800">
                Formatar Headers
            </button>
        </div>
        <div>
            <label for="requestBody" class="block text-sm font-medium text-gray-700 mb-1">Corpo da requisição (JSON)</label>
            <textarea id="requestBody" class="w-full p-2 border rounded mb-2" placeholder="Corpo da requisição em JSON" rows="4">${node.requestBody || ''}</textarea>
        </div>
        <div>
            <label for="responseVariable" class="block text-sm font-medium text-gray-700 mb-1">Nome da variável para armazenar resposta</label>
            <input type="text" id="responseVariable" class="w-full p-2 border rounded mb-2" placeholder="Nome da variável" value="${node.responseVariable || ''}">
        </div>
        <div class="mt-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
            <div class="flex items-center space-x-2">
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
                <button onclick="insertVariableToApiFields()" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Inserir
                </button>
            </div>
        </div>
        <button onclick="testApiRequest()" class="mt-4 bg-green-500 text-white px-4 py-2 rounded">Testar Requisição</button>
        <div id="apiResponse" class="mt-2 p-2 border rounded hidden"></div>
    `;
    break;
  
    case 'image':
case 'video':
    content = `
        <div>
            <label for="nodeContent" class="block text-sm font-medium text-gray-700 mb-1">LINK DA MIDIA</label>
            <textarea id="nodeContent" class="w-full p-2 border rounded" rows="4">${node.content}</textarea>
        </div>
        <div class="mt-2">
            <label for="nodeCaption" class="block text-sm font-medium text-gray-700 mb-1">Legenda (opcional)</label>
            <input type="text" id="nodeCaption" class="w-full p-2 border rounded" placeholder="Legenda" value="${node.caption || ''}">
        </div>
        <div class="mt-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
            <div class="flex items-center space-x-2">
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
                <button onclick="insertVariable('nodeContent')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Inserir
                </button>
            </div>
        </div>
    `;
    break;
    case 'audio':
    content = `
        <div>
            <label for="nodeContent" class="block text-sm font-medium text-gray-700 mb-1">LINK DA MIDIA</label>
            <textarea id="nodeContent" class="w-full p-2 border rounded" rows="4">${node.content}</textarea>
        </div>
         <div class="mt-2">
        <label for="recordDelay" class="block text-sm font-medium text-gray-700 mb-1">Tempo para gravar áudio (segundos)</label>
        <input type="number" id="recordDelay" class="w-full p-2 border rounded" value="${node.recordDelay || 0}" min="0">
    </div>
        <div class="mt-2">
            <label class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
            <div class="flex items-center space-x-2">
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
                <button onclick="insertVariable('nodeContent')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                    Inserir
                </button>
            </div>
        </div>
    `;
    break;
    case 'randomMessage':
    content = `
        <div id="messageList" class="space-y-2"></div>
        <button onclick="addMessageInput()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Adicionar Mensagem</button>
    `;
    if (node.messages && node.messages.length > 0) {
        node.messages.forEach((msg, index) => {
            content += `<input type="text" class="messageInput w-full p-2 border rounded" value="${msg}">`;
        });
    }
    break;
           
         
            case 'file':
                content = `
                    <textarea id="nodeContent" class="w-full p-2 border rounded" rows="4">${node.content}</textarea>
                    
                `;
                break;
                case 'generatePayment':
                content = `
                <div class="p-4 space-y-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">ID do Pagamento</span>
                        </label>
                        <input type="text" id="paymentId" class="input input-bordered" 
                               value="${node.paymentId || ''}" 
                               placeholder="ID único para este pagamento">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Valor do Pagamento (R$)</span>
                        </label>
                        <input type="number" id="paymentAmount" class="input input-bordered" 
                               value="${node.amount || ''}" min="0.01" step="0.01">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Descrição do Pagamento</span>
                        </label>
                        <input type="text" id="paymentDescription" class="input input-bordered" 
                               value="${node.description || ''}">
                    </div>

                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Tempo de Espera (minutos)</span>
                            <span class="label-text-alt text-gray-500">Após este tempo, se não houver pagamento, o fluxo 'Não Pago' será acionado</span>
                        </label>
                        <input type="number" id="paymentTimeout" class="input input-bordered" 
                               value="${node.timeout || 15}" min="1" max="1440">
                    </div>

                    <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                        <h3 class="text-sm font-semibold text-gray-700 mb-2">Fluxos de Saída:</h3>
                        <ul class="list-disc list-inside text-sm text-gray-600">
                            <li>Conexão Verde (Direita) → Fluxo quando o pagamento é confirmado</li>
                            <li>Conexão Vermelha (Baixo) → Fluxo quando o tempo expira sem pagamento</li>
                        </ul>
                    </div>
                </div>`;
                break;
    case 'checkPayment':
    content = `
        <div class="form-control">
            <label class="label">
                <span class="label-text">ID do Pagamento a Verificar</span>
            </label>
            <select id="paymentToCheck" class="select select-bordered w-full">
                <option value="">Selecione um pagamento</option>
                ${getPaymentOptions()}
            </select>
        </div>
    `;
    break;
    case 'message':
    content = `
    <div class="space-y-4">
        <div>
            <label for="nodeContent" class="block text-sm font-medium text-gray-700 mb-1">Mensagem</label>
            <textarea id="nodeContent" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" rows="4" placeholder="Digite sua mensagem aqui...">${node.content}</textarea>
        </div>
         <div>
            <label for="typeDelay" class="block text-sm font-medium text-gray-700 mb-1">Tempo para digitar (segundos)</label>
            <input type="number" id="typeDelay" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" value="${node.typeDelay || 0}" min="0">
        </div>
        <div class="flex items-center space-x-2">
            <div class="flex-grow">
                <label for="variableSelect" class="block text-sm font-medium text-gray-700 mb-1">Inserir variável</label>
                <select id="variableSelect" class="w-full p-2 border rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                    <option value="">Selecione uma variável</option>
                    ${getVariableOptions()}
                </select>
            </div>
            <button onclick="insertVariable('nodeContent')" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mt-6">
                Inserir
            </button>
        </div>
        
        <div>
            <p class="text-sm text-gray-500 mt-2">Variáveis disponíveis:</p>
            <div id="availablePlaceholders" class="mt-1 flex flex-wrap gap-2">
                ${getAvailablePlaceholders()}
            </div>
        </div>
    </div>`;
    break;
            case 'input':
            node.saveResponse = node.saveResponse !== undefined ? node.saveResponse : true;

                content = `
                  <!-- No modal de edição do nó de input -->
<input type="text" id="nodeContent" class="w-full p-2 border rounded mb-2" value="${node.content}" placeholder="Pergunta">
<input type="text" id="inputKey" class="w-full p-2 border rounded mb-2" value="${node.inputKey || ''}" placeholder="Chave do input (ex: pergunta1)">
 <div>
                <label for="typeDelay" class="block text-sm font-medium text-gray-700 mb-1">Tempo para digitar (segundos)</label>
                <input type="number" id="typeDelay" class="w-full p-2 border rounded mb-2" value="${node.typeDelay || 0}" min="0">
            </div>
<div class="flex items-center mb-2">
  <input type="checkbox" id="saveResponse" class="mr-2" ${node.saveResponse !== false ? 'checked' : ''}>

    <label for="saveResponse">Salvar resposta do usuário</label>
</div>
                `;
                break;
                case 'condition':
    const inputNodes = nodes.filter(n => n.type === 'input');
    const apiNodes = nodes.filter(n => n.type === 'apiRequest');
    const aiNodes = nodes.filter(n => n.type === 'aiAgent' || n.type === 'aiCondition');
    const nameExtractorNodes = nodes.filter(n => n.type === 'nameExtractor');

    const variableOptions = [
        ...inputNodes.map(n => `<option value="input:${n.inputKey}" ${node.variable === `input:${n.inputKey}` ? 'selected' : ''}>${n.inputKey} (Input)</option>`),
        ...apiNodes.flatMap(n => n.selectedFields ? n.selectedFields.map(field => `<option value="api:${n.id}:${field}" ${node.variable === `api:${n.id}:${field}` ? 'selected' : ''}>${field} (API)</option>`) : []),
        ...aiNodes.map(n => {
            const shortId = `AI_${n.id.substr(-4)}`;
            return `<option value="ai:${n.id}" ${node.variable === `ai:${n.id}` ? 'selected' : ''}>${shortId} (AI Response)</option>`;
        }),
        ...nameExtractorNodes.map(n => `<option value="nameExtractor:${n.outputVariable}" ${node.variable === `nameExtractor:${n.outputVariable}` ? 'selected' : ''}>${n.outputVariable} (Nome Extraído)</option>`)
    ].join('');

    content = `
        <select id="variableSelect" class="w-full p-2 border rounded mb-2">
            <option value="">Selecione uma variável</option>
            ${variableOptions}
        </select>
        <select id="conditionType" class="w-full p-2 border rounded mb-2">
            <option value="equals" ${node.conditionType === 'equals' ? 'selected' : ''}>Igual a</option>
            <option value="contains" ${node.conditionType === 'contains' ? 'selected' : ''}>Contém</option>
            <option value="startsWith" ${node.conditionType === 'startsWith' ? 'selected' : ''}>Começa com</option>
            <option value="endsWith" ${node.conditionType === 'endsWith' ? 'selected' : ''}>Termina com</option>
            <option value="containsAny" ${node.conditionType === 'containsAny' ? 'selected' : ''}>Contém as mensagens</option>
        </select>
        <div id="conditionValueContainer">
            ${node.conditionType === 'containsAny' 
                ? `<div id="messageList" class="space-y-2"></div>
                   <button onclick="addConditionMessage()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Adicionar Mensagem</button>`
                : `<input type="text" id="conditionValue" class="w-full p-2 border rounded mb-2" value="${node.conditionValue || ''}" placeholder="Valor da condição">`
            }
        </div>
    `;
    break;
            case 'wait':
                content = `
                    <input type="number" id="nodeContent" class="w-full p-2 border rounded" value="${node.content}" min="1" max="300" placeholder="Tempo de espera em segundos">
                `;
                break;

                case 'typing':
        case 'recordAudio':
            content = `
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Duração (segundos)</span>
                    </label>
                    <input type="number" id="actionDuration" class="input input-bordered" value="${node.duration || 5}" min="1" max="60">
                </div>
            `;
            break;
            case 'addToGroup':
        case 'removeFromGroup':
            content = `
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Selecione a Instância</span>
                    </label>
                    <select id="instanceSelect" class="select select-bordered w-full mb-2" onchange="loadGroups()">
                        <option value="">Selecione uma instância</option>
                    </select>
                </div>
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">Selecione o Grupo</span>
                    </label>
                    <select id="groupSelect" class="select select-bordered w-full">
                        <option value="">Primeiro selecione uma instância</option>
                    </select>
                </div>
            `;
            break;
        case 'sendFile':
            content = `
                <div class="form-control">
                    <label class="label">
                        <span class="label-text">URL do Arquivo</span>
                    </label>
                    <input type="text" id="fileUrl" class="input input-bordered" value="${node.fileUrl || ''}">
                </div>
            `;
            break;
        case 'visualize':
            content = `
                <p>Este nó marca a mensagem como visualizada.</p>
            `;
            break;

            case 'image':
            case 'audio':
case 'video':
setTimeout(() => {
        const contentInput = document.getElementById('nodeContent');
        if (contentInput) {
            // Remove eventos antigos antes de adicionar o novo
            contentInput.removeEventListener('input', updatePreview);
            
            // Cria uma função de callback nomeada para poder removê-la depois
            function updatePreview(e) {
                updateMediaPreviewRealTime(nodeId, e.target.value);
            }
            
            contentInput.addEventListener('input', updatePreview);
            
            // Atualizar preview inicial se já houver URL
            if (node.content) {
                updateMediaPreviewRealTime(nodeId, node.content);
            }
        }
    }, 0);
    break
        }

        document.getElementById('modalContent').innerHTML = content;
        document.getElementById('editModal').classList.remove('hidden');
        

        if (node.type === 'addToGroup' || node.type === 'removeFromGroup') {
        loadUserInstances();
        if (node.instanceKey) {
            document.getElementById('instanceSelect').value = node.instanceKey;
            loadGroups(node.groupId);
        }
    }
    }

 
// Adicione este código após a criação do conteúdo do modal
if (node.type === 'condition') {
    setTimeout(() => {
        const conditionTypeSelect = document.getElementById('conditionType');
        conditionTypeSelect.addEventListener('change', function() {
            const container = document.getElementById('conditionValueContainer');
            if (this.value === 'containsAny') {
                container.innerHTML = `
                    <div id="messageList" class="space-y-2"></div>
                    <button onclick="addConditionMessage()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Adicionar Mensagem</button>
                `;
                if (node.conditionValues) {
                    node.conditionValues.forEach(value => addConditionMessage(value));
                }
            } else {
                container.innerHTML = `
                    <input type="text" id="conditionValue" class="w-full p-2 border rounded mb-2" value="${node.conditionValue || ''}" placeholder="Valor da condição">
                `;
            }
        });
    }, 0);
}

    // Adicione um event listener para o select
document.getElementById('conditionType').addEventListener('change', function() {
    const container = document.getElementById('conditionValueContainer');
    if (this.value === 'containsAny') {
        container.innerHTML = `
            <div id="messageList" class="space-y-2"></div>
            <button onclick="addConditionMessage()" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Adicionar Mensagem</button>
        `;
        if (node.conditionValues) {
            node.conditionValues.forEach(value => addConditionMessage(value));
        }
    } else {
        container.innerHTML = `
            <input type="text" id="conditionValue" class="w-full p-2 border rounded mb-2" value="${node.conditionValue || ''}" placeholder="Valor da condição">
        `;
    }
});

function addConditionMessage(value = '') {
    const messageList = document.getElementById('messageList');
    const input = document.createElement('input');
    input.type = 'text';
    input.className = 'conditionMessage w-full p-2 border rounded mt-2';
    input.value = value;
    messageList.appendChild(input);
}

    function loadUserInstances() {
    const instanceSelect = document.getElementById('instanceSelect');
    instanceSelect.innerHTML = '<option value="" disabled selected>Escolha uma instância</option>';
    
    const instances = <%- JSON.stringify(user.whatsappInstances) %>;
    
    instances.forEach(instance => {
        const option = document.createElement('option');
        option.value = instance.key;
        option.textContent = instance.name;
        instanceSelect.appendChild(option);
    });
}

function loadGroups(selectedGroupId) {
    const instanceSelect = document.getElementById('instanceSelect');
    const groupSelect = document.getElementById('groupSelect');
    const selectedInstance = instanceSelect.value;

    if (!selectedInstance) {
        groupSelect.innerHTML = '<option value="">Primeiro selecione uma instância</option>';
        return;
    }

    groupSelect.innerHTML = '<option value="">Carregando grupos...</option>';

    fetch(`/group/all?instanceKey=${selectedInstance}`)
        .then(response => response.json())
        .then(data => {
            if (!data.error) {
                groupSelect.innerHTML = Object.entries(data.data).map(([id, group]) => 
                    `<option value="${id}" ${id === selectedGroupId ? 'selected' : ''}>${group.subject}</option>`
                ).join('');
                
                if (groupSelect.innerHTML === '') {
                    groupSelect.innerHTML = '<option value="">Nenhum grupo encontrado</option>';
                }
            } else {
                groupSelect.innerHTML = '<option value="">Erro: ${data.message}</option>';
            }
        })
        .catch(error => {
            console.error('Erro ao carregar grupos:', error);
            groupSelect.innerHTML = '<option value="">Erro ao carregar grupos</option>';
        });
}

function updateStickerPreview(url) {
    const preview = document.getElementById('stickerPreview');
    const img = preview.querySelector('img');
    
    if (url) {
        img.src = url;
        img.onload = () => preview.classList.remove('hidden');
        img.onerror = () => {
            preview.classList.add('hidden');
            Swal.fire('Erro', 'Não foi possível carregar a imagem', 'error');
        };
    } else {
        preview.classList.add('hidden');
    }
}

async function handleVideoUpload(input) {
    const file = input.files[0];
    if (!file) return;

    const node = nodes.find(n => n.id === editingNodeId);
    if (node) {
        node.videoFile = file;
        node.videoName = file.name;
        node.videoUrl = URL.createObjectURL(file);

        // Atualizar preview
        const preview = document.getElementById('videoPreview');
        const video = preview.querySelector('video');
        video.src = node.videoUrl;
        preview.classList.remove('hidden');
    }
}
async function searchLocation() {
    const input = document.getElementById('locationInput').value;
    if (!input) return;

    try {
        // Usar a API do Nominatim (OpenStreetMap) para geocoding
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(input)}`);
        const data = await response.json();

        if (data && data[0]) {
            const { lat, lon, display_name } = data[0];
            
            document.getElementById('latitude').value = lat;
            document.getElementById('longitude').value = lon;
            document.getElementById('locationAddress').textContent = display_name;
            document.getElementById('locationPreview').classList.remove('hidden');

            // Salvar no node
            const node = nodes.find(n => n.id === editingNodeId);
            if (node) {
                node.latitude = lat;
                node.longitude = lon;
                node.address = display_name;
            }
        } else {
            Swal.fire('Erro', 'Localização não encontrada', 'error');
        }
    } catch (error) {
        console.error('Erro ao buscar localização:', error);
        Swal.fire('Erro', 'Erro ao buscar localização', 'error');
    }
}

function getAvailablePlaceholders() {
    return nodes
        .filter(n => n.type === 'input' && n.saveResponse)
        .map(n => `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800 cursor-pointer hover:bg-indigo-200" onclick="insertSpecificPlaceholder('input:${n.inputKey}')">{{${n.inputKey}}}</span>`)
        .concat(nodes
            .filter(n => n.type === 'apiRequest')
            .flatMap(n => {
                if (n.selectedFields && n.selectedFields.length > 0) {
                    return n.selectedFields.map(field => 
                        `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200" onclick="insertSpecificPlaceholder('api:${n.id}:${field}')">{{${field}}}</span>`
                    );
                } else {
                    return [`<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800 cursor-pointer hover:bg-green-200" onclick="insertSpecificPlaceholder('api:${n.id}')">{{${n.responseVariable || 'API Response'}}}</span>`];
                }
            })
        )
        .concat(nodes
            .filter(n => n.type === 'aiAgent' || n.type === 'aiCondition')
            .map(n => {
                const shortId = n.shortId || `AI_${n.id.substr(-4)}`;
                return `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800 cursor-pointer hover:bg-purple-200" onclick="insertSpecificPlaceholder('ai:${shortId}')">{{${shortId}}}</span>`;
            })
        )
        .concat(nodes
            .filter(n => n.type === 'nameExtractor')
            .map(n => `<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 cursor-pointer hover:bg-yellow-200" onclick="insertSpecificPlaceholder('nameExtractor:${n.outputVariable}')">{{${n.outputVariable}}}</span>`)
        )
        .join('');
}

function insertSpecificPlaceholder(key) {
    const textarea = document.getElementById('nodeContent');
    const placeholder = `{{${key}}}`;
    insertAtCursor(textarea, placeholder);
}

function insertAtCursor(textarea, text) {
    const startPos = textarea.selectionStart;
    const endPos = textarea.selectionEnd;
    textarea.value = textarea.value.substring(0, startPos) + text + textarea.value.substring(endPos, textarea.value.length);
    textarea.focus();
    textarea.selectionStart = startPos + text.length;
    textarea.selectionEnd = startPos + text.length;
}

function getSavedResponseOptions() {
    return nodes
        .filter(n => n.type === 'input' && n.saveResponse)
        .map(n => `<option value="${n.inputKey}">${n.inputKey}</option>`)
        .join('');
}

function insertSpecificPlaceholder(key) {
    const textarea = document.getElementById('nodeContent');
    const placeholder = `{{${key}}}`;
    insertAtCursor(textarea, placeholder);
}

function generateButtonInputs(node) {
    const buttons = node.buttons || [];
    return buttons.map((button, index) => generateButtonInput(button, index, node.buttonType)).join('');
}

function generateButtonInput(button, index, type) {
    let specificFields = '';
    
    // Campos base do botão
    const baseFields = `
        <div class="button-input border p-4 rounded-lg relative mb-4" data-index="${index}">
            <button type="button" onclick="removeButton(${index})" 
                class="absolute top-2 right-2 text-red-500 hover:text-red-700">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-1">Texto do Botão</label>
                <input type="text" 
                    class="button-text w-full p-2 border rounded" 
                    value="${button?.displayText || ''}" 
                    placeholder="Texto exibido no botão"
                    required>
            </div>`;

    // Campos específicos baseados no tipo
    try {
        switch (type) {
            case 'reply':
            specificFields = `
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID da Resposta</label>
                    <input type="text" 
                        class="button-id w-full p-2 border rounded" 
                        value="${button?.id || `btn_${Date.now()}_${index}`}" 
                        placeholder="ID único para a resposta"
                        readonly>
                    <p class="text-xs text-gray-500 mt-1">ID gerado automaticamente</p>
                </div>`;
            break;

            case 'copy':
                specificFields = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Texto para Copiar</label>
                        <textarea 
                            class="button-copy w-full p-2 border rounded" 
                            rows="2" 
                            placeholder="Texto que será copiado"
                            required>${button?.copyCode || ''}</textarea>
                    </div>`;
                break;

            case 'url':
                specificFields = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">URL</label>
                        <input type="url" 
                            class="button-url w-full p-2 border rounded" 
                            value="${button?.url || ''}" 
                            placeholder="https://exemplo.com"
                            required>
                    </div>`;
                break;

            case 'call':
                specificFields = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Número de Telefone</label>
                        <input type="tel" 
                            class="button-phone w-full p-2 border rounded" 
                            value="${button?.phoneNumber || ''}" 
                            placeholder="557499879409"
                            required>
                    </div>`;
                break;

            case 'pix':
                specificFields = `
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Nome</label>
                        <input type="text" 
                            class="button-name w-full p-2 border rounded" 
                            value="${button?.name || ''}" 
                            placeholder="Nome completo"
                            required>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Tipo da Chave</label>
                        <select class="button-keytype w-full p-2 border rounded" required>
                            <option value="phone" ${button?.keyType === 'phone' ? 'selected' : ''}>Telefone</option>
                            <option value="email" ${button?.keyType === 'email' ? 'selected' : ''}>Email</option>
                            <option value="cpf" ${button?.keyType === 'cpf' ? 'selected' : ''}>CPF</option>
                            <option value="cnpj" ${button?.keyType === 'cnpj' ? 'selected' : ''}>CNPJ</option>
                            <option value="random" ${button?.keyType === 'random' ? 'selected' : ''}>Aleatória</option>
                        </select>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Chave PIX</label>
                        <input type="text" 
                            class="button-key w-full p-2 border rounded" 
                            value="${button?.key || ''}" 
                            placeholder="Chave PIX"
                            required>
                    </div>`;
                break;
        }
    } catch (error) {
        console.error('Erro ao gerar campos específicos:', error);
        specificFields = '<p class="text-red-500">Erro ao carregar campos</p>';
    }

    return baseFields + specificFields + '</div>';
}
function addButton() {
    const node = nodes.find(n => n.id === editingNodeId);
    if (!node.buttons) node.buttons = [];
    if (node.buttons.length >= 4) return;

    // Gera um ID único para o botão
    const newButton = {
        type: node.buttonType,
        displayText: '',
        id: `btn_${Date.now()}_${Math.random().toString(36).substr(2, 9)}` // ID único
    };

    node.buttons.push(newButton);
    document.getElementById('buttonsList').innerHTML = generateButtonInputs(node);
    updateAddButtonState();
}

function removeButton(index) {
    const node = nodes.find(n => n.id === editingNodeId);
    if (!node.buttons) return;

    node.buttons.splice(index, 1);
    document.getElementById('buttonsList').innerHTML = generateButtonInputs(node);
    updateAddButtonState();
}

function updateAddButtonState() {
    const node = nodes.find(n => n.id === editingNodeId);
    const addBtn = document.getElementById('addButtonBtn');
    addBtn.disabled = node.buttons?.length >= 4;
}

function updateButtonFields() {
    const node = nodes.find(n => n.id === editingNodeId);
    node.buttonType = document.getElementById('buttonType').value;
    node.buttons = [];
    document.getElementById('buttonsList').innerHTML = '';
    updateAddButtonState();
}


function formatHeaders() {
    const headersTextarea = document.getElementById('requestHeaders');
    try {
        const headersObj = Function(`return ${headersTextarea.value}`)();
        const formattedHeaders = JSON.stringify(headersObj, null, 2);
        headersTextarea.value = formattedHeaders;
    } catch (error) {
        Swal.fire({
            icon: 'error',
            title: 'Erro ao formatar headers',
            text: 'Os headers não estão em um formato válido. Por favor, verifique e tente novamente.',
        });
    }
}

    function saveNodeEdit() {
    const node = nodes.find(n => n.id === editingNodeId);
    if (!node) return;

    const contentElement = document.getElementById('nodeContent');
    if (contentElement) {
        node.content = contentElement.value;
    }

    
    switch (node.type) {
        // ... (mantenha os casos existentes)
        case 'buttons':
    try {
        node.title = document.getElementById('buttonTitle').value;
        node.description = document.getElementById('buttonDescription').value;
        node.footer = document.getElementById('buttonFooter').value;
        node.buttonType = document.getElementById('buttonType').value;
        
        // Inicializa o array de botões se não existir
        if (!node.buttons) {
            node.buttons = [];
        }

        // Coleta os dados dos botões existentes
        const buttonInputs = document.querySelectorAll('.button-input');
        node.buttons = Array.from(buttonInputs).map((buttonEl, index) => {
            // Cria o objeto base do botão
            const button = {
                type: node.buttonType,
                displayText: buttonEl.querySelector('.button-text')?.value || ''
            };

            try {
                switch (node.buttonType) {
                    case 'reply':
                        const idInput = buttonEl.querySelector('.button-id');
                        // Usa o ID existente ou gera um novo
                        button.id = idInput?.value || `btn_${Date.now()}_${index}`;
                        break;
                        
                    case 'copy':
                        const copyInput = buttonEl.querySelector('.button-copy');
                        if (copyInput) {
                            button.copyCode = copyInput.value;
                        }
                        break;
                        
                    case 'url':
                        const urlInput = buttonEl.querySelector('.button-url');
                        if (urlInput) {
                            button.url = urlInput.value;
                        }
                        break;
                        
                    case 'call':
                        const phoneInput = buttonEl.querySelector('.button-phone');
                        if (phoneInput) {
                            button.phoneNumber = phoneInput.value;
                        }
                        break;
                        
                    case 'pix':
                        const nameInput = buttonEl.querySelector('.button-name');
                        const keyTypeInput = buttonEl.querySelector('.button-keytype');
                        const keyInput = buttonEl.querySelector('.button-key');
                        
                        if (nameInput) button.name = nameInput.value;
                        if (keyTypeInput) button.keyType = keyTypeInput.value;
                        if (keyInput) button.key = keyInput.value;
                        button.currency = 'BRL';
                        break;
                }
            } catch (error) {
                console.error('Erro ao processar botão:', error);
            }

            return button;
        });

        // Valida se há botões configurados
        if (node.buttons.length === 0) {
            throw new Error('Adicione pelo menos um botão.');
        }

        // Valida os campos obrigatórios
        if (!node.title || !node.description) {
            throw new Error('Título e descrição são obrigatórios.');
        }

        // Valida os campos específicos de cada tipo de botão
        node.buttons.forEach(button => {
            switch (button.type) {
                case 'reply':
                    if (!button.id) throw new Error('ID é obrigatório para botões de resposta.');
                    break;
                case 'copy':
                    if (!button.copyCode) throw new Error('Texto para copiar é obrigatório.');
                    break;
                case 'url':
                    if (!button.url) throw new Error('URL é obrigatória.');
                    break;
                case 'call':
                    if (!button.phoneNumber) throw new Error('Número de telefone é obrigatório.');
                    break;
                case 'pix':
                    if (!button.name || !button.key) {
                        throw new Error('Nome e chave PIX são obrigatórios.');
                    }
                    break;
            }
        });

    } catch (error) {
        // Exibe mensagem de erro usando SweetAlert2
        Swal.fire({
            icon: 'error',
            title: 'Erro ao salvar',
            text: error.message
        });
        return; // Impede o fechamento do modal se houver erro
    }
    break;

        case 'message':
    node.content = document.getElementById('nodeContent').value;
    node.typeDelay = parseInt(document.getElementById('typeDelay').value) || 0;
    break;
    case 'videoMessage':
    node.content = document.getElementById('nodeContent').value;
            break;

        case 'stickerMessage':
            node.stickerUrl = document.getElementById('stickerUrl').value;
            break;

        case 'fakeCall':
            node.duration = parseInt(document.getElementById('callDuration').value);
            node.isVideo = document.getElementById('isVideoCall').checked;
            break;

        case 'location':
            node.latitude = document.getElementById('latitude').value;
            node.longitude = document.getElementById('longitude').value;
            node.address = document.getElementById('locationAddress').textContent;
            break;
        case 'nameExtractor':
    node.aiPrompt = document.getElementById('aiPrompt').value;
    node.outputVariable = document.getElementById('outputVariable').value;
    break;

        case 'collectNumber':
                // Não há configurações adicionais para este nó
                break;
            case 'savePurchaseEvent':
                node.eventType = document.getElementById('eventType').value;
                break;
            case 'sendToOtherNumber':
                node.targetNumber = document.getElementById('targetNumber').value;
                node.messageType = document.getElementById('messageType').value;
                node.messageContent = document.getElementById('messageContent').value;
                break;
        case 'randomMessage':
            node.messages = Array.from(document.querySelectorAll('.messageInput'))
                .map(input => input.value)
                .filter(value => value.trim() !== ''); // Remove mensagens vazias
            break;
            case 'aiAgent':
            node.aiPrompt = document.getElementById('aiPrompt').value;
            node.aiMemoryId = document.getElementById('aiMemoryId').value;
            if (!node.shortId) {
                node.shortId = `AI_${node.id.substr(-4)}`;
                node.aiResponseVariable = `{{${node.shortId}}}`;
            }
            break;
        case 'aiCondition':
            node.aiSystemInstruction = document.getElementById('aiSystemInstruction').value;
            node.aiConditionPrompt = document.getElementById('aiConditionPrompt').value;
            node.aiConditionVariable = document.getElementById('aiConditionVariable').value;
            break;
            case 'apiRequest':
    node.apiUrl = document.getElementById('apiUrl').value;
    node.requestType = document.getElementById('requestType').value;
    node.requestBody = document.getElementById('requestBody').value;
    node.responseVariable = document.getElementById('responseVariable').value;
    
    // Salvar os campos selecionados
    node.selectedFields = Array.from(document.querySelectorAll('#apiDataFields input[type="checkbox"]:checked'))
        .map(checkbox => checkbox.value);
    
    // Tratar os headers
    try {
        const headersText = document.getElementById('requestHeaders').value;
        const headersObj = Function(`return ${headersText}`)();
        node.headers = JSON.parse(JSON.stringify(headersObj));
    } catch (error) {
        console.error('Erro ao analisar os headers:', error);
        Swal.fire({
            icon: 'error',
            title: 'Erro nos Headers',
            text: 'Os headers não estão em um formato válido. Por favor, corrija e tente novamente.',
        });
        return;
    }
    break;

        case 'input':
        const inputKeyElement = document.getElementById('inputKey');
        const saveResponseElement = document.getElementById('saveResponse');
        if (inputKeyElement) {
            node.inputKey = inputKeyElement.value;
        }
        if (saveResponseElement) {
            node.saveResponse = saveResponseElement.checked;
        }
        node.typeDelay = parseInt(document.getElementById('typeDelay').value) || 0;
            break
            case 'image':
        case 'video':
            node.content = document.getElementById('nodeContent').value;
            node.caption = document.getElementById('nodeCaption').value;
            break;
   
        case 'audio':
        node.content = document.getElementById('nodeContent').value;
        node.recordDelay = parseInt(document.getElementById('recordDelay').value) || 0;
            break;
            case 'generatePayment':
            node.paymentId = document.getElementById('paymentId').value || `payment_${Date.now()}`;
            node.amount = parseFloat(document.getElementById('paymentAmount').value);
            node.description = document.getElementById('paymentDescription').value;
            node.timeout = parseInt(document.getElementById('paymentTimeout').value) || 15;
            break;
        case 'checkPayment':
            node.paymentToCheck = document.getElementById('paymentToCheck').value;
            break;
            case 'condition':
    node.variable = document.getElementById('variableSelect').value;
    node.conditionType = document.getElementById('conditionType').value;
    if (node.conditionType === 'containsAny') {
        node.conditionValues = Array.from(document.querySelectorAll('.conditionMessage')).map(input => input.value);
        node.conditionValue = null; // Limpar conditionValue quando usar containsAny
    } else {
        node.conditionValue = document.getElementById('conditionValue').value;
        node.conditionValues = null; // Limpar conditionValues quando não usar containsAny
    }
    break;


        case 'typing':
        case 'recordAudio':
            node.duration = parseInt(document.getElementById('actionDuration').value);
            break;
         case 'addToGroup':
        case 'removeFromGroup':
            node.instanceKey = document.getElementById('instanceSelect').value;
            node.groupId = document.getElementById('groupSelect').value;
            break;

        // ... (outros casos)
    
        case 'sendFile':
            node.fileUrl = document.getElementById('fileUrl').value;
            break;
    }




    updateNodeDisplay(node);
    if (['image', 'audio', 'video'].includes(node.type)) {
        updateMediaPreview(node.id, node.content);
    }

    closeModal();
    onNodeChange();
}

function updateNodeDisplay(node) {
    const contentElement = document.getElementById(`content_${node.id}`);
    if (contentElement) {
        let displayContent = node.content;


        if (node.type === 'buttons' && node.buttonType === 'reply') {
        setTimeout(() => {
            if (node.buttonEndpoints) {
                node.buttonEndpoints.forEach((buttonEndpoint, index) => {
                    const buttonElement = document.getElementById(buttonEndpoint.id);
                    if (buttonElement) {
                        jsPlumbInstance.addEndpoint(buttonElement, {
                            anchor: "Right",
                            isSource: true,
                            isTarget: false,
                            maxConnections: 1,
                            endpoint: ["Dot", { radius: 4 }],
                            paintStyle: { fill: "#48BB78" }
                        });
                    }
                });
            }
        }, 100);
    }

        switch (node.type) {
            case 'buttons':
            displayContent = `
                <div class="p-4">
                    <div class="mb-2">
                        <p class="font-medium text-gray-700">${node.title || 'Sem título'}</p>
                        <p class="text-sm text-gray-600">${node.description || 'Sem descrição'}</p>
                    </div>
                    ${node.buttonType === 'reply' ? `
                        <div class="button-list mt-3 space-y-2">
                            ${node.buttons?.map((button, index) => `
                                <div class="button-container" id="button-${node.id}-${index}">
                                    <span class="button-text">${button.displayText}</span>
                                    <div class="button-endpoint"></div>
                                </div>
                            `).join('') || ''}
                        </div>
                    ` : ''}
                </div>
            `;
            break;
            case 'randomPath':
            // Conte o número de conexões de saída
            const connections = jsPlumbInstance.getConnections({ source: node.id });
            content = `
                <div class="p-4 space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h3 class="text-lg font-medium text-gray-900">Configuração de Caminhos Aleatórios</h3>
                        <p class="mt-2 text-sm text-gray-600">
                            Este nó permite criar múltiplos caminhos de saída. Um deles será escolhido aleatoriamente durante a execução.
                        </p>
                        <div class="mt-4">
                            <p class="text-sm font-medium text-gray-700">Caminhos conectados: ${connections.length}</p>
                            <p class="text-xs text-gray-500 mt-1">Conecte mais nós para adicionar caminhos possíveis.</p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 bg-yellow-50 p-4 rounded-lg">
                        <svg class="w-5 h-5 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <p class="text-sm text-yellow-700">
                            Cada vez que este nó for executado, um caminho diferente pode ser escolhido.
                        </p>
                    </div>
                </div>
            `;
            break;
            case 'videoMessage':
            const truncatedUrl2 = truncateUrl(node.content);
        displayContent = `
             <div class="space-y-2">
                    <p class="text-sm text-gray-600 break-all">URL: ${truncatedUrl2}</p>
                    ${node.caption ? `<p class="text-sm">Legenda: ${node.caption}</p>` : ''}
                </div>`;
        break;

    case 'stickerMessage':
        displayContent = `
            <div class="p-2">
                <p class="text-sm font-medium text-gray-700">Figurinha</p>
                ${node.stickerUrl ?
                    `<p class="text-xs text-green-600 mt-1">✓ URL configurada</p>
                     <div class="mt-2 w-16 h-16 rounded border">
                        <img src="${node.stickerUrl}" class="w-full h-full object-contain" 
                             onerror="this.src='/path/to/fallback-image.png'">
                     </div>` :
                    '<p class="text-xs text-gray-500 mt-1">Nenhuma URL configurada</p>'
                }
            </div>`;
        break;

    case 'fakeCall':
        displayContent = `
            <div class="p-2">
                <p class="text-sm font-medium text-gray-700">Chamada Fake</p>
                <div class="flex items-center mt-1">
                    <span class="flex items-center text-xs ${node.isVideo ? 'text-purple-600' : 'text-blue-600'}">
                        ${node.isVideo ? 
                            '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>' :
                            '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>'
                        }
                        Chamada de ${node.isVideo ? 'Vídeo' : 'Voz'}
                    </span>
                </div>
                <div class="flex items-center mt-2">
                    <svg class="w-4 h-4 text-gray-500 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <p class="text-xs text-gray-600">Duração: ${node.duration || 5} segundos</p>
                </div>
            </div>`;
        break;

    case 'location':
        displayContent = `
            <div class="p-2">
                <p class="text-sm font-medium text-gray-700">Enviar Localização</p>
                ${node.address ?
                    `<div class="mt-2 space-y-2">
                        <div class="flex items-start">
                            <svg class="w-4 h-4 text-gray-500 mr-1 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path>
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
                            </svg>
                            <div>
                                <p class="text-xs text-gray-700 font-medium break-all">${node.address}</p>
                                <p class="text-xs text-gray-500 mt-1">
                                    Lat: ${node.latitude}, Long: ${node.longitude}
                                </p>
                            </div>
                        </div>
                        <div class="bg-blue-50 rounded p-1.5">
                            <p class="text-xs text-blue-700">✓ Localização configurada</p>
                        </div>
                    </div>` :
                    '<p class="text-xs text-gray-500 mt-1">Localização não configurada</p>'
                }
            </div>`;
        break;

            case 'typing':
                displayContent = `Digitar por ${node.duration} segundos`;
                break;
            case 'recordAudio':
                displayContent = `Gravar áudio por ${node.duration} segundos`;
                break;
                case 'addToGroup':
                displayContent = `Adicionar ao grupo: ${node.groupId || 'Não selecionado'} (Instância: ${node.instanceKey || 'Não selecionada'})`;
                break;
            case 'removeFromGroup':
                displayContent = `Remover do grupo: ${node.groupId || 'Não selecionado'} (Instância: ${node.instanceKey || 'Não selecionada'})`;
                break;
                case 'generatePayment':
                displayContent = `
                    <div class="text-sm">
                        <p class="font-semibold text-green-600">R$ ${node.amount?.toFixed(2) || '0.00'}</p>
                        <p class="text-gray-600">${node.description || 'Sem descrição'}</p>
                        <p class="text-gray-500 mt-1">⏱️ ${node.timeout || 15} minutos</p>
                    </div>`;
                break;

            case 'checkPayment':
                displayContent = `Verificar pagamento: ${node.paymentToCheck || 'Não selecionado'}`;
                break;
            case 'sendFile':
                displayContent = `Enviar arquivo: ${node.fileUrl}`;
                break;
            case 'visualize':
                displayContent = 'Visualizar mensagem';
                break;
                case 'condition':
    const [varType, varId, varField] = node.variable.split(':');
    let varName = varField || varId;
    displayContent = `Se ${varName} ${node.conditionType} "${node.conditionValue || node.conditionValues?.join(', ')}"`;
    break;
            case 'input':
            displayContent = `${node.content} (${node.inputKey})`;
    if (node.typeDelay > 0) {
        displayContent += `<br>Tempo para digitar: ${node.typeDelay}s`;
    }
                break;

                case 'aiAgent':
                displayContent = `Prompt: ${node.aiPrompt ? node.aiPrompt.substring(0, 50) + '...' : 'Não definido'}`;
                displayContent += `<br>Variável de resposta: ${node.aiResponseVariable}`;
                break;
                case 'nameExtractor':
    displayContent = `Extrai nome de: ${node.aiPrompt ? node.aiPrompt.substring(0, 50) + '...' : 'Não definido'}<br>Salva em: ${node.outputVariable || 'Não definido'}`;
    break;
            case 'apiRequest':
                displayContent = `URL: ${node.apiUrl ? node.apiUrl.substring(0, 50) + '...' : 'Não definida'}`;
                break;
                case 'randomMessage':
                if (node.messages && node.messages.length > 0) {
                    displayContent = `Mensagens aleatórias (${node.messages.length}):<br>` +
                        node.messages.map((msg, index) => `${index + 1}. ${msg.substring(0, 30)}...`).join('<br>');
                } else {
                    displayContent = 'Nenhuma mensagem definida';
                }
                break;
                case 'image':
        case 'video':
        case 'audio':
            const truncatedUrl = truncateUrl(node.content);
            displayContent = `
                <div class="space-y-2">
                    <p class="text-sm text-gray-600 break-all">URL: ${truncatedUrl}</p>
                    ${node.caption ? `<p class="text-sm">Legenda: ${node.caption}</p>` : ''}
                </div>
            `;
            break;

        }

       // Atualizar o ID exibido
    const footerElement = document.querySelector(`#${node.id} .node-footer`);
    if (footerElement) {
        const shortId = node.type === 'aiAgent' ? `AI_${node.id.substr(-4)}` : node.id;
        footerElement.innerHTML = `<span class="text-xs text-gray-500">ID: ${shortId}</span>`;
    }

        contentElement.innerHTML = `<p>${displayContent}</p>`;

         // Recriar endpoints para botões se necessário
    if (node.type === 'buttons' && node.buttonType === 'reply') {
        setTimeout(() => {
            node.buttons?.forEach((button, index) => {
                const buttonElement = document.getElementById(`button-${node.id}-${index}`);
                if (buttonElement) {
                    jsPlumbInstance.addEndpoint(buttonElement, {
                        anchor: "Right",
                        isSource: true,
                        isTarget: false,
                        maxConnections: 1,
                        endpoint: ["Dot", { radius: 4 }],
                        paintStyle: { fill: "#48BB78" }
                    });
                }
            });
        }, 100);
    }

    // Recriar o preview se for um nó de mídia
    if (['image', 'audio', 'video'].includes(node.type) && node.content) {
        updateMediaPreviewRealTime(node.id, node.content);
    }
    }
}

function updateMediaPreview(nodeId, url) {
    const previewElement = document.getElementById(`preview_${nodeId}`);
    if (!previewElement) return;

    const node = nodes.find(n => n.id === nodeId);
    if (!node) return;

    switch (node.type) {
        case 'image':
            previewElement.innerHTML = `<img src="${url}" alt="Preview" class="media-preview">`;
            break;
        case 'audio':
            previewElement.innerHTML = `<audio controls src="${url}" class="media-preview"></audio>`;
            break;
        case 'video':
            previewElement.innerHTML = `<video controls src="${url}" class="media-preview"></video>`;
            break;
    }
}

    function closeModal() {
        document.getElementById('editModal').classList.add('hidden');
        editingNodeId = null;
    }

    function deleteNode(nodeId) {
        Swal.fire({
            title: 'Tem certeza?',
            text: "Você não poderá reverter isso!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Sim, delete!',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                const nodeElement = document.getElementById(nodeId);
                if (nodeElement) {
                    jsPlumbInstance.remove(nodeElement);
                }
                nodes = nodes.filter(n => n.id !== nodeId);
                connections = connections.filter(c => c.sourceId !== nodeId && c.targetId !== nodeId);
                Swal.fire(
                    'Deletado!',
                    'O nó foi deletado.',
                    'success'
                );
                onNodeChange();
            }
        });
    }

    function isValidJSON(str) {
    try {
        JSON.parse(str);
        return true;
    } catch (e) {
        return false;
    }
}

    function saveFunnel() {
    const funnelData = {
        name: document.getElementById('funnelName').textContent,
        nodes: nodes.map(node => {
     

            const nodeElement = document.getElementById(node.id);
       

            const nodeData = {
                id: node.id,
                type: node.type,
              content: node.type === 'start' ? '' : node.content,
                position: {
                    left: nodeElement ? nodeElement.style.left : node.position.left,
                    top: nodeElement ? nodeElement.style.top : node.position.top
                },
                delay: node.type === 'message' || node.type === 'input' ? node.typeDelay : node.type === 'audio' ? node.recordDelay : 0
            };

            // Adicionar dados específicos para cada tipo de nó
            switch (node.type) {
                case 'collectNumber':
                    // Não há dados adicionais para este nó
                    break;
                  
                    case 'buttons':
        nodeData.title = node.title;
        nodeData.description = node.description;
        nodeData.footer = node.footer;
        nodeData.buttonType = node.buttonType;
        nodeData.buttons = node.buttons.map(button => {
            const buttonData = {
                type: button.type,
                displayText: button.displayText
            };

            switch (button.type) {
                case 'reply':
                    buttonData.id = button.id;
                    break;
                case 'copy':
                    buttonData.copyCode = button.copyCode;
                    break;
                case 'url':
                    buttonData.url = button.url;
                    break;
                case 'call':
                    buttonData.phoneNumber = button.phoneNumber;
                    break;
                case 'pix':
                    buttonData.name = button.name;
                    buttonData.keyType = button.keyType;
                    buttonData.key = button.key;
                    buttonData.currency = 'BRL';
                    break;
            }

            return buttonData;
        });
        break;

        case 'stickerMessage':
        nodeData.stickerUrl = node.stickerUrl;
            break;
            
        case 'fakeCall':
        nodeData.duration = node.duration
            nodeData.isVideo = node.isVideo
            break;
            
        case 'location':
        nodeData.latitude = node.latitude
        nodeData.longitude = node.longitude
        nodeData.address = node.address
            break;
                    case 'nameExtractor':
                    nodeData.aiPrompt = node.aiPrompt;
                    nodeData.outputVariable = node.outputVariable;
                    break;
                case 'savePurchaseEvent':
                    nodeData.eventType = node.eventType;
                    break;
                case 'sendToOtherNumber':
                    nodeData.targetNumber = node.targetNumber;
                    nodeData.messageType = node.messageType;
                    nodeData.messageContent = node.messageContent;
                    break;
                case 'input':
                    nodeData.inputKey = node.inputKey;
                    nodeData.saveResponse = node.saveResponse;
                  //  nodeData.delay = node.typeDelay
                    break;
                    case 'condition':
                    nodeData.variable = node.variable;
                    nodeData.conditionType = node.conditionType;
                    nodeData.conditionValue = node.conditionValue;
                    nodeData.conditionValues = node.conditionValues;
                    break;
                    case 'randomMessage':
                    nodeData.messages = node.messages;
                    break;
                    case 'apiRequest':
                    nodeData.apiUrl = node.apiUrl;
                    nodeData.requestType = node.requestType;
                    nodeData.requestBody = node.requestBody;
                    nodeData.responseVariable = node.responseVariable;
                    nodeData.headers = node.headers;
                    nodeData.selectedFields = node.selectedFields;
                    break;
                case 'aiAgent':
                    nodeData.aiPrompt = node.aiPrompt;
                    nodeData.aiMemoryId = node.aiMemoryId;
                    break;
                case 'aiCondition':
                    nodeData.aiSystemInstruction = node.aiSystemInstruction;
                    nodeData.aiConditionPrompt = node.aiConditionPrompt;
                    nodeData.aiConditionVariable = node.aiConditionVariable;
                    break;
                    case 'generatePayment':
                    nodeData.amount = node.amount;
                    nodeData.description = node.description;
                    nodeData.paymentId = node.paymentId;
                    nodeData.timeout = node.timeout || 15; // Inclui o timeout nos dados salvos
                    break;
                case 'checkPayment':
                    nodeData.paymentToCheck = node.paymentToCheck;
                    break;
                case 'typing':
                case 'recordAudio':
                    nodeData.duration = node.duration;
                    break;
                    case 'addToGroup':
                case 'removeFromGroup':
                    nodeData.instanceKey = node.instanceKey;
                    nodeData.groupId = node.groupId;
                    break;
                case 'sendFile':
                    nodeData.fileUrl = node.fileUrl;
                    break;
                case 'image':
                case 'audio':
                case 'video':
                    nodeData.caption = node.caption;
                    break;
            }

            return nodeData;
        }),
        connections: jsPlumbInstance.getConnections().map(conn => ({
            sourceId: conn.sourceId,
            targetId: conn.targetId,
            anchors: [conn.endpoints[0].anchor.type, conn.endpoints[1].anchor.type]
        }))
    };

    fetch('/funnels/api/update/<%= funnel.id %>', {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(funnelData),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            Swal.fire(
                'Salvo!',
                'Seu funil foi salvo com sucesso.',
                'success'
            );
        } else {
            throw new Error(data.error || 'Erro ao salvar o funil');
        }
    })
    .catch(error => {
        Swal.fire(
            'Erro!',
            'Ocorreu um erro ao salvar o funil: ' + error.message,
            'error'
        );
    });
}

function createConnection(source, target, anchors) {
    const sourceNode = nodes.find(n => n.id === source);
    const isConditionOrCheckPayment = sourceNode && (sourceNode.type === 'condition' || sourceNode.type === 'checkPayment');
    const isNoConnection = anchors && anchors[0] === 'Bottom';


    let paintStyle = { stroke: "#6366F1", strokeWidth: 2 }; // Estilo padrão
    
    if (sourceNode && sourceNode.type === 'generatePayment') {
        const isTimeout = anchors && anchors[0] === 'Bottom';
        paintStyle = {
            stroke: isTimeout ? '#EF4444' : '#10B981',
            strokeWidth: 2
        };
    }

    let color = '#6366F1'; // cor padrão
    if (isConditionOrCheckPayment) {
        color = isNoConnection ? '#F56565' : '#48BB78';
    }

    jsPlumbInstance.connect({
        source: source,
        target: target,
        paintStyle: { stroke: color, strokeWidth: 2 },
        connector: ["Flowchart", { curviness: 50 }],
        anchors: anchors || ["Right", "Left"],
        endpoint: ["Dot", { radius: 5 }],
    });
}

function getConnectionColor(connection) {
    const sourceNode = nodes.find(n => n.id === connection.sourceId);
    if (sourceNode && (sourceNode.type === 'condition' || sourceNode.type === 'checkPayment')) {
        return connection.anchors[0] === 'Bottom' ? '#F56565' : '#48BB78';
    }
    return '#6366F1';
}
    function zoomIn() {
        zoom(0.1);
    }

    function zoomOut() {
        zoom(-0.1);
    }

    function zoom(delta) {
        const container = document.querySelector('.canvas-container');
        const canvas = document.getElementById('canvas');

        // Obter a posição do scroll antes do zoom
        const scrollXRatio = container.scrollLeft / (canvas.scrollWidth - container.clientWidth);
        const scrollYRatio = container.scrollTop / (canvas.scrollHeight - container.clientHeight);

        zoomLevel += delta;
        zoomLevel = Math.max(0.5, Math.min(zoomLevel, 2)); // Limita o zoom entre 0.5 e 2
        canvas.style.transform = `scale(${zoomLevel})`;
        jsPlumbInstance.setZoom(zoomLevel);

        // Reposicionar o scroll após o zoom
        setTimeout(() => {
            container.scrollLeft = scrollXRatio * (canvas.scrollWidth - container.clientWidth);
            container.scrollTop = scrollYRatio * (canvas.scrollHeight - container.clientHeight);
        }, 0);

        repositionConnections();
    }

    function repositionConnections() {
        jsPlumbInstance.repaintEverything();
    }

    function updateCanvasSize() {
  const canvas = document.getElementById('canvas');
  const nodes = document.querySelectorAll('.node');
  let maxX = 0;
  let maxY = 0;

  nodes.forEach(node => {
    const rect = node.getBoundingClientRect();
    maxX = Math.max(maxX, rect.right);
    maxY = Math.max(maxY, rect.bottom);
  });

  canvas.style.width = Math.max(5000, maxX + 500) + 'px';
  canvas.style.height = Math.max(5000, maxY + 500) + 'px';
}

    function onNodeChange() {
        updateCanvasSize();
        repositionConnections();
    }

    function centerCanvas() {
        const container = document.querySelector('.canvas-container');
        const canvas = document.getElementById('canvas');
        
        container.scrollLeft = (canvas.scrollWidth - container.clientWidth) / 2;
        container.scrollTop = (canvas.scrollHeight - container.clientHeight) / 2;
    }

    function focusOnNode(nodeId) {
    const node = document.getElementById(nodeId);
    if (node) {
        const container = document.querySelector('.canvas-container');
        const canvas = document.getElementById('canvas');
        
        const nodeRect = node.getBoundingClientRect();
        const canvasRect = canvas.getBoundingClientRect();

        const scrollX = nodeRect.left - canvasRect.left - (container.clientWidth / 2) + (nodeRect.width / 2);
        const scrollY = nodeRect.top - canvasRect.top - (container.clientHeight / 2) + (nodeRect.height / 2);

        container.scrollTo({
            left: scrollX,
            top: scrollY,
            behavior: 'smooth'
        });
    }
}


function startDragging(e) {
        isDragging = true;
        startX = e.pageX - container.offsetLeft;
        startY = e.pageY - container.offsetTop;
        scrollLeft = container.scrollLeft;
        scrollTop = container.scrollTop;
    }

    function drag(e) {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - container.offsetLeft;
        const y = e.pageY - container.offsetTop;
        const walkX = (x - startX) * 2;
        const walkY = (y - startY) * 2;
        container.scrollLeft = scrollLeft - walkX;
        container.scrollTop = scrollTop - walkY;
    }

    function stopDragging() {
        isDragging = false;
    }

    // Adicionar listeners para arrastar e soltar
    jsPlumbInstance.bind("connection", function(info) {
        const sourceNode = nodes.find(n => n.id === info.sourceId);
    if (sourceNode && sourceNode.type === 'generatePayment') {
        const isTimeout = info.sourceEndpoint.anchor.type === 'Bottom';
        info.connection.setPaintStyle({ 
            stroke: isTimeout ? '#EF4444' : '#10B981',
            strokeWidth: 2
        });
    }
    
        connections.push({
            sourceId: info.sourceId,
            targetId: info.targetId,
            anchors: info.connection.endpoints.map(ep => ep.anchor.type)
        });
    });

    jsPlumbInstance.bind("connectionDetached", function(info) {
        connections = connections.filter(conn =>
            conn.sourceId !== info.sourceId || conn.targetId !== info.targetId
        );
    });

    // Função para atualizar a posição dos nós após arrastar
    jsPlumbInstance.bind("connectionMoved", function(info) {
        const nodeElement = document.getElementById(info.newSourceId);
        const node = nodes.find(n => n.id === info.newSourceId);
        if (node && nodeElement) {
            node.position = {
                left: nodeElement.style.left,
                top: nodeElement.style.top
            };
        }
    });

    // Atualizar posições dos nós ao arrastar
    jsPlumbInstance.bind("drag:stop", function (info) {
        const nodeId = info.el.id;
        const node = nodes.find(n => n.id === nodeId);
        if (node) {
            node.position = {
                left: info.finalPos[0] + 'px',
                top: info.finalPos[1] + 'px'
            };
        }
        onNodeChange();
    });

    
    // Atualizar o tamanho do canvas quando a janela for redimensionada
    window.addEventListener('resize', updateCanvasSize);
</script>


<script>
    // menu.js

(function() {
    const menuItems = {
    messages: [
        { type: 'message', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />', label: 'Mensagem' },
        { type: 'image', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />', label: 'Imagem' },
        { type: 'audio', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />', label: 'Áudio' },
        { type: 'video', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />', label: 'Vídeo' },
        { 
            type: 'videoMessage', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z" />', 
            label: 'Recado de Vídeo' 
        },
        { 
            type: 'location', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />', 
            label: 'Enviar Localização' 
        },
        { 
        type: 'buttons', 
        icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 5v2m0 4v2m0 4v2M5 5a2 2 0 00-2 2v3a2 2 0 110 4v3a2 2 0 002 2h14a2 2 0 002-2v-3a2 2 0 110-4V7a2 2 0 00-2-2H5z" />', 
        label: 'Botões' 
    },
        { 
            type: 'stickerMessage', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />', 
            label: 'Enviar Figurinha' 
        },
        { type: 'randomMessage', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />', label: 'Mensagens Aleatórias' },
    ],
    ias: [
        // Adicione outros nós relacionados a IA aqui, se necessário
    ],
    logic: [
    { type: 'nameExtractor', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />', label: 'Extrator de nomes' },
       { 
            type: 'randomPath', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />', 
            label: 'Caminhos Aleatórios' 
        },
        { type: 'input', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />', label: 'Input' },
        { type: 'condition', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />', label: 'Condição' },
      //  { type: 'aiCondition', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />', label: 'Condição com IA' },
        { type: 'wait', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />', label: 'Espera' },
    ],
    actions: [
    { 
            type: 'fakeCall', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />', 
            label: 'Chamada Fake' 
        },
       
        { type: 'aiAgent', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />', label: 'Agente de IA' },
        { type: 'apiRequest', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />', label: 'Requisição API' },
        { 
            type: 'generatePayment', 
            icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />', 
            label: 'Gerar Pagamento PIX' 
        },
    //    { type: 'checkPayment', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />', label: 'Verificar Pagamento' },
        { type: 'collectNumber', label: 'Coletar Número', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>'},
       // { type: 'typing', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />', label: 'Digitar' },
      //  { type: 'recordAudio', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />', label: 'Gravar Áudio' },
        { type: 'addToGroup', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" />', label: 'Add ao Grupo' },
        { type: 'removeFromGroup', icon: '<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7a4 4 0 11-8 0 4 4 0 018 0zM9 14a6 6 0 00-6 6v1h12v-1a6 6 0 00-6-6zM21 12h-6" />', label: 'Remover do Grupo' },
    ]
};

    function populateMenu() {
  const messagesItems = document.getElementById('messagesItems');
  const logicItems = document.getElementById('logicItems');
  const actionsItems = document.getElementById('actionsItems');

  function createMenuItem(item) {
    return `
      <div class="menu-item" data-type="${item.type}">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          ${item.icon}
        </svg>
        <span>${item.label}</span>
      </div>
    `;
}

  messagesItems.innerHTML = menuItems.messages.map(createMenuItem).join('');
  logicItems.innerHTML = menuItems.logic.map(createMenuItem).join('');
  actionsItems.innerHTML = menuItems.actions.map(createMenuItem).join('');

  // Adicionar event listeners
  document.querySelectorAll('.menu-item').forEach(item => {
    item.addEventListener('click', function() {
      const type = this.getAttribute('data-type');
      addNewNode(type);
    });
  });
}

// Chamar esta função quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', populateMenu);
document.addEventListener('DOMContentLoaded', initializeDragAndDrop);
    // Expor funções necessárias globalmente
    window.showTab = showTab;
})();
</script>
</body>
</html>